---
{"dg-publish":true,"permalink":"/(2_021)(算法解析)/√(20221028)-(过程解析)-(000)-(数仓)-(灵活配置批量更新-P_TABLE_SYNC_T)/"}
---


# <font color=#DC143C>(20221028)-(过程解析)-(000)-(数仓)-(灵活配置批量更新-P_TABLE_SYNC_T)</font>
URL:: 

```
dataview
table without id 入榜亮点, 入榜输出
where contains(TITLES, "")
```

| 萃取函数 | 萃取解法 |
| ---- | ---- |
| \-   | \-   |


```toc
```

## 逻辑压缩
+ 创建执行语句历史记录表：`.dbo.OPERATION_RECORD`
+ 参数读取：`@TABLE_INFO_PARM(报表参数)`
    + 字段`FROM_TABLE`：数据来源
    + 字段`INTO_TABLE`：写入目标
+ 调用模型`TALLY TABLE`判断数据来源`FROM_TABLE`是三段式(本服务器)还是四段式(跨服务器)
    + 三段式：`DATABASE.DBO.TABLE`
    + 四段式：`DATABASE_LINK.DATABASE.DBO.TABLE`
+ 获取列名
    + 源头数据
        + `SET @COLUMNNAME_FROMTABLE_CMD_PARM = N'SELECT dbo.HEADGET(''''' + @FROM_TABLE + N''''')';`
        + `SET @COLUMNNAME_FROMTABLE_CMD_PARM = N'EXEC ' + @FROM_TABLE_DBNAME + N'.sys.sp_executesql ' + N'N''' + @COLUMNNAME_FROMTABLE_CMD_PARM + N'''';`
    + 目标数据
        + `SET @COLUMNNAME_INTOTABLE_CMD_PARM = N'SELECT dbo.HEADGET(''''' + @INTO_TABLE + N''''')';`
        + `SET @COLUMNNAME_INTOTABLE_CMD_PARM = N'EXEC ' + @INTO_TABLE_DBNAME + N'.sys.sp_executesql ' + N'N''' + @COLUMNNAME_INTOTABLE_CMD_PARM + N'''';`
+ 更新插入：两段拼接式
    + 删除数据：判断删除条件`LEN(@DELETE_CONDITION) > 0`是否赋值，注意`@DELETE_CONDITION`赋值必须从`WHERE`开始书写。
        + 是→调用`DELETE FROM`
        + 否→调用`TRUNCATE TABLE`
    + 插入数据：判断插入条件`LEN(@UPDATE_CONDITION) > 0`是否赋值，注意`@UPDATE_CONDITION`赋值必须从`WHERE`开始书写。
+ 记录执行语句：`INSERT INTO dbo.OPERATION_RECORD(CMD_RECORD) SELECT @CMD;`

## 配置案例
```SQL
USE [odsdbfq];
GO
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[基础数据|20210511|192.168.5.166|湖南首批]
/*CREATE TABLE*/

IF OBJECT_ID('.dbo.TABLE_INFO_TEST', 'u') IS NOT NULL DROP TABLE dbo.TABLE_INFO_TEST;
CREATE TABLE dbo.TABLE_INFO_TEST
(
FROM_TABLE VARCHAR(1000),
INTO_TABLE VARCHAR(1000),
UPDATE_CONDITION VARCHAR(2000),
delete_CONDITION VARCHAR(2000),
ZhangHao sysname DEFAULT SUSER_SNAME(),
NUM INT IDENTITY(1, 1) NOT NULL
);
/*TRUNCATE TABLE*/
TRUNCATE TABLE TABLE_INFO_TEST;
/*配置参数*/
INSERT INTO TABLE_INFO_TEST(FROM_TABLE, INTO_TABLE, UPDATE_CONDITION, delete_CONDITION)
SELECT 'odsdbfq.dbo.store_new', 'odsdbfq_mid.dbo.store_new_to166', NULL, 'where 1= 1' /*store_new*/
UNION ALL
SELECT 'database_5_161.odsdb_Basic.dbo.brand', 'odsdbfq_mid.dbo.brand_to166', NULL, 'where 1= 1'; /*brand*/
```

## (p_table_sync_T)-(20221028)-(000)-(工具)
```SQL
USE [odsdb]
GO
/****** Object:  StoredProcedure [dbo].[p_table_sync_T]    Script Date: 2022/10/28 11:49:49 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[p_table_sync_T](@TABLE_INFO_PARM_INPUT NVARCHAR(MAX),
                                  @BREAKPOINT_INPUT INT = 0)
AS
BEGIN
SET NOCOUNT ON
--*******************************************************************************************************************************************************************
--创建人员:徐海权
--创建时间:20210512
--创建用途:灵活配置批量更新报表数据
--生成结果:
           --执行语句历史记录:SELECT * FROM dbo.OPERATION_RECORD WITH(NOLOCK);
--修改时间:20210804(徐海权)
--修改内容:跨库同步|删除方式判断
--*******************************************************************************************************************************************************************
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[定义变量]
/*DECLARE*/
DECLARE @TABLE_INFO_PARM NVARCHAR(MAX);
DECLARE @CMD_TABLE_INFO_PARM NVARCHAR(MAX);
DECLARE @FROM_TABLE NVARCHAR(200);
DECLARE @INTO_TABLE NVARCHAR(200);
DECLARE @UPDATE_CONDITION NVARCHAR(MAX);
DECLARE @DELETE_CONDITION NVARCHAR(MAX);
DECLARE @BREAKPOINT INT;
DECLARE @CMD_CNT INT;
DECLARE @CMD_CNT_MAX INT;
DECLARE @FROM_TABLE_DBNAME NVARCHAR(200);
DECLARE @INTO_TABLE_DBNAME NVARCHAR(200);
DECLARE @DATABASE_USING NVARCHAR(200);
DECLARE @COLUMNNAME_FROMTABLE_CMD_PARM NVARCHAR(MAX);
DECLARE @COLUMNNAME_INTOTABLE_CMD_PARM NVARCHAR(MAX);
--DECLARE @COLUMNNAME_FROMTABLE NVARCHAR(MAX);
--DECLARE @COLUMNNAME_INTOTABLE NVARCHAR(MAX);
DECLARE @CMD NVARCHAR(MAX);
/*SET_BREAKPOINT*/
--SELECT @TABLE_INFO_PARM = N'odsdbfq.dbo.TABLE_INFO_PARM_XHQ_TO166';
--SELECT @FROM_TABLE = 'odsdbfq.dbo.store';
--SELECT @INTO_TABLE = 'odsdbfq_mid.dbo.store_to166';
--SELECT @UPDATE_CONDITION = 'WHERE a.gid = b.gid';
--SELECT @UPDATE_CONDITION = NULL;
--SELECT @BREAKPOINT = 1;
--SELECT @BREAKPOINT = 0;
/*SET_INPUT*/
SET @TABLE_INFO_PARM = @TABLE_INFO_PARM_INPUT;
SET @BREAKPOINT = @BREAKPOINT_INPUT;
SET @CMD_CNT = 1;
/*执行语句历史记录*/
IF OBJECT_ID('.dbo.OPERATION_RECORD', 'U') IS NOT NULL DROP TABLE dbo.OPERATION_RECORD;
CREATE TABLE OPERATION_RECORD(CMD_RECORD NVARCHAR(MAX), TIME_RECORD DATETIME DEFAULT CURRENT_TIMESTAMP);
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[参数转换]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[@TABLE_INFO_PARM(报表参数)]
/*[READ_TABLE_INFO_PARM;]*/
IF OBJECT_ID('.dbo.READ_TABLE_INFO_PARM', 'u') IS NOT NULL DROP TABLE READ_TABLE_INFO_PARM;
SET @CMD_TABLE_INFO_PARM = N'SELECT *' + CHAR(13) + CHAR(10) + 
                           N'INTO READ_TABLE_INFO_PARM' + CHAR(13) + CHAR(10) + 
                           N'FROM ' + @TABLE_INFO_PARM + N' WITH(NOLOCK)';
/*@BREAKPOINT_READ*/
IF @BREAKPOINT = 1 BEGIN PRINT @CMD_TABLE_INFO_PARM END;
/*EXEC*/
--IF @BREAKPOINT = 0 BEGIN EXEC sp_executesql @stmt = @CMD_TABLE_INFO_PARM END;
EXEC SP_EXECUTESQL @STMT = @CMD_TABLE_INFO_PARM;
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[@CMD_CNT_MAX]
SELECT @CMD_CNT_MAX = MAX(num) FROM dbo.READ_TABLE_INFO_PARM WITH(NOLOCK);
IF @BREAKPOINT = 1 BEGIN SELECT '进程最大数量:' + CAST(@CMD_CNT_MAX AS NVARCHAR(200)) AS CMD_CNT_MAX END;
--✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹[1]
WHILE(@CMD_CNT <= @CMD_CNT_MAX)
BEGIN
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[读取参数]
SELECT TOP 1 @FROM_TABLE = FROM_TABLE FROM dbo.READ_TABLE_INFO_PARM WITH(NOLOCK) WHERE num = @CMD_CNT;
SELECT TOP 1 @INTO_TABLE = INTO_TABLE FROM dbo.READ_TABLE_INFO_PARM WITH(NOLOCK) WHERE num = @CMD_CNT;
SELECT TOP 1 @UPDATE_CONDITION = UPDATE_CONDITION FROM dbo.READ_TABLE_INFO_PARM WITH(NOLOCK) WHERE NUM = @CMD_CNT;
SELECT TOP 1 @DELETE_CONDITION = DELETE_CONDITION FROM dbo.READ_TABLE_INFO_PARM WITH(NOLOCK) WHERE NUM = @CMD_CNT;
/*@BREAKPOINT_READ*/
IF @BREAKPOINT = 1
BEGIN
SELECT @FROM_TABLE AS FROM_TABLE,
       @INTO_TABLE AS INTO_TABLE,
       @UPDATE_CONDITION AS UPDATE_CONDITION,
       @DELETE_CONDITION AS DELETE_CONDITION;
END;
/*@DATABASE_USING:执行库名*/
SELECT @DATABASE_USING = [NAME]
FROM MASTER.dbo.sysdatabases WITH(NOLOCK)
WHERE EXISTS(SELECT *
             FROM MASTER.dbo.sysprocesses WITH(NOLOCK)
             WHERE SPID = @@SPID AND sysprocesses.dbid = sysdatabases.dbid);
/*DEFAULT_DBNAME:本库执行*/
SELECT @FROM_TABLE_DBNAME = @DATABASE_USING;
SELECT @INTO_TABLE_DBNAME = @DATABASE_USING;
/*@FROM_TABLE:跨库执行*/
IF CHARINDEX('.', @FROM_TABLE, 1) > 0
BEGIN
     WITH TALLY(N)
     AS (SELECT TOP(ISNULL(DATALENGTH(@FROM_TABLE), 0))ROW_NUMBER()OVER(ORDER BY(SELECT NULL))
         FROM MASTER.SYS.ALL_COLUMNS AS a WITH(NOLOCK)
         CROSS JOIN MASTER.SYS.ALL_COLUMNS AS b WITH(NOLOCK)),
     PICK_UP(ONEWORD)
     AS (SELECT SUBSTRING(@FROM_TABLE, N, 1) AS ONEWORD
         FROM TALLY WITH(NOLOCK)),
     POINTCNT
     AS (SELECT COUNT(0) AS POINT_CNT
         FROM PICK_UP WITH(NOLOCK)
         WHERE ONEWORD = '.')
     SELECT @FROM_TABLE_DBNAME = (CASE WHEN POINT_CNT = 2 THEN LEFT(@FROM_TABLE, (CHARINDEX('.', @FROM_TABLE, 1) - 1))
                                       WHEN POINT_CNT = 3 THEN LEFT(@FROM_TABLE, (CHARINDEX('.', @FROM_TABLE, CHARINDEX('.', @FROM_TABLE, 1) + 1) - 1))
                                  END)
     FROM POINTCNT WITH(NOLOCK);
     SELECT @FROM_TABLE = REVERSE(LEFT(REVERSE(@FROM_TABLE), CHARINDEX('.', REVERSE(@FROM_TABLE), 1) - 1));
END
/*@INTO_TABLE:跨库执行*/
IF CHARINDEX('.', @INTO_TABLE, 1) > 0
BEGIN
     WITH TALLY(N)
     AS (SELECT TOP(ISNULL(DATALENGTH(@INTO_TABLE), 0))ROW_NUMBER()OVER(ORDER BY(SELECT NULL))
         FROM MASTER.SYS.ALL_COLUMNS AS a WITH(NOLOCK)
         CROSS JOIN MASTER.SYS.ALL_COLUMNS AS b WITH(NOLOCK)),
     PICK_UP(ONEWORD)
     AS (SELECT SUBSTRING(@INTO_TABLE, N, 1) AS ONEWORD
         FROM TALLY WITH(NOLOCK)),
     POINTCNT
     AS (SELECT COUNT(0) AS POINT_CNT
         FROM PICK_UP WITH(NOLOCK)
         WHERE ONEWORD = '.')
     SELECT @INTO_TABLE_DBNAME = (CASE WHEN POINT_CNT = 2 THEN LEFT(@INTO_TABLE, (CHARINDEX('.', @INTO_TABLE, 1) - 1))
                                       WHEN POINT_CNT = 3 THEN LEFT(@INTO_TABLE, (CHARINDEX('.', @INTO_TABLE, CHARINDEX('.', @INTO_TABLE, 1) + 1) - 1))
                                  END)
     FROM POINTCNT WITH(NOLOCK);
     SELECT @INTO_TABLE = REVERSE(LEFT(REVERSE(@INTO_TABLE), CHARINDEX('.', REVERSE(@INTO_TABLE), 1) - 1));
END;
/*@BREAKPOINT_READ*/
IF @BREAKPOINT = 1
BEGIN
     SELECT @FROM_TABLE AS FROM_TABLE,
            @FROM_TABLE_DBNAME AS FROM_TABLE_DBNAME;
     SELECT @INTO_TABLE AS INTO_TABLE,
            @INTO_TABLE_DBNAME AS INTO_TABLE_DBNAME;
END
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[获取列名]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[CREATE TABLE]
/*[#FROMTABLE_CMD_PARM]*/
IF OBJECT_ID('tempdb.dbo.#FROMTABLE_CMD_PARM', 'U') IS NOT NULL DROP TABLE #FROMTABLE_CMD_PARM;
CREATE TABLE #FROMTABLE_CMD_PARM(ColumnAll NVARCHAR(MAX));
/*[#INTOTABLE_CMD_PARM]*/
IF OBJECT_ID('tempdb.dbo.#INTOTABLE_CMD_PARM', 'U') IS NOT NULL DROP TABLE #INTOTABLE_CMD_PARM;
CREATE TABLE #INTOTABLE_CMD_PARM(ColumnAll NVARCHAR(MAX));
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[CMD_HEADGET|源头表]
IF CHARINDEX('.', @FROM_TABLE_DBNAME, 1) = 0
BEGIN
     /*STEP_1*/
     SET @COLUMNNAME_FROMTABLE_CMD_PARM = N'SELECT dbo.HEADGET(''''' + @FROM_TABLE + N''''')';
     /*STEP_2*/
     SET @COLUMNNAME_FROMTABLE_CMD_PARM = N'EXEC ' + @FROM_TABLE_DBNAME + N'.sys.sp_executesql ' + N'N''' + @COLUMNNAME_FROMTABLE_CMD_PARM + N'''';
     /*STEP_3*/
     INSERT INTO #FROMTABLE_CMD_PARM EXEC sp_executesql @stmt = @COLUMNNAME_FROMTABLE_CMD_PARM;
END
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[CMD_HEADGET|目标表]
/*STEP_1*/
SET @COLUMNNAME_INTOTABLE_CMD_PARM = N'SELECT dbo.HEADGET(''''' + @INTO_TABLE + N''''')';
/*STEP_2*/
SET @COLUMNNAME_INTOTABLE_CMD_PARM = N'EXEC ' + @INTO_TABLE_DBNAME + N'.sys.sp_executesql ' + N'N''' + @COLUMNNAME_INTOTABLE_CMD_PARM + N'''';
/*STEP_3*/
INSERT INTO #INTOTABLE_CMD_PARM EXEC SP_EXECUTESQL @STMT = @COLUMNNAME_INTOTABLE_CMD_PARM;
/*@BREAKPOINT_READ*/
IF @BREAKPOINT = 1
BEGIN
     SELECT * FROM #FROMTABLE_CMD_PARM;
     SELECT * FROM #INTOTABLE_CMD_PARM;
END
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[更新插入]
/*SET*/
SET @CMD = CASE WHEN LEN(@DELETE_CONDITION) > 0
                THEN N'DELETE FROM ' + @INTO_TABLE_DBNAME + N'.dbo.' + @INTO_TABLE + SPACE(1) + @DELETE_CONDITION
                ELSE N'TRUNCATE TABLE ' + @INTO_TABLE_DBNAME + N'.dbo.' + @INTO_TABLE
           END
SET @CMD = @CMD + CHAR(13) + CHAR(10) + 
           N'INSERT INTO ' + @INTO_TABLE_DBNAME + N'.dbo.' + @INTO_TABLE + N'(' + (SELECT ColumnAll FROM #INTOTABLE_CMD_PARM WITH(NOLOCK)) + N')' + CHAR(13) + CHAR(10) + 
           N'SELECT ' + (SELECT ColumnAll FROM #INTOTABLE_CMD_PARM WITH(NOLOCK)) + CHAR(13) + CHAR(10) + 
           N'FROM ' + @FROM_TABLE_DBNAME + N'.dbo.' + @FROM_TABLE + N' WITH(NOLOCK)' + CHAR(13) + CHAR(10) + 
           CASE WHEN LEN(@UPDATE_CONDITION) > 0 THEN @UPDATE_CONDITION ELSE '' END;
/*@BREAKPOINT_READ*/
IF @BREAKPOINT = 1 BEGIN PRINT @CMD END;
/*写入记录*/
INSERT INTO dbo.OPERATION_RECORD(CMD_RECORD)
SELECT @CMD;
/*EXEC*/
IF @BREAKPOINT = 0 BEGIN EXEC SP_EXECUTESQL @STMT = @CMD END;
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[NEXT]
SET @CMD_CNT = @CMD_CNT + 1;
END
--✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹[1]
--*******************************************************************************************************************************************************************
SET NOCOUNT OFF
END
```