---
{"dg-publish":true,"permalink":"/2-021/20220616-000/"}
---


# <font color=#DC143C>(20220616)-(任务封闭)-(000)-(项目)-(商品主子品牌匹配清洗)</font>

```
dataview
table without id 入榜亮点, 入榜输出
where contains(TITLES, "")
```

```toc
```

## 主线任务-20220615
### 逻辑压缩
+ 1.导入数据
    + 1.1目标数据——`task_goods_infoclean`
    + 1.2引用数据——`task_goods_Brand_BVName`
    + 1.3引用数据——`task_goods_Brand_BVName_WITHSORT`
+ 2.结构建立
    + 2.1建立TallyTable→生成`#TALLY`
    + 2.2结果存放:`odsdbtemp.dbo.Brand_BVName_Result`
+ 3.逐字拆分
    + 3.1利用步骤[2]逐字拆分商品名称→生成`goods_infoclean_single_split`
    + 3.2利用步骤[2]逐字拆分引用数据→生成主品牌表`task_goods_Brand_BVName_single_split`
    + 3.3利用步骤[2]逐字拆分引用数据→生成子品牌表`task_goods_Brand_BVName_single_split_2`
+ 4.通过步骤[1.1]目标数据`DISTINCT ID16`→生成`#ID`(单行循环处理)
+ 5.主品牌
    + 5.1定义循环计数变量`DECLARE @NUM INT;`
    + 5.2根据随机选取的字段`ID16`提取单条处理记录→生成`#goods_infoclean_single_split`
        + a.提取记录的商品名称赋值给变量`@GDNAME`
    + 5.3首轮匹配:逐字匹配不论顺序——集合思想——`ON a.VALUESTRING = b.VALUESTRING`→生成`#FIRSTMATCH`
        + a.此处匹配目标数据——`task_goods_Brand_BVName_single_split`
        + b.聚合匹配数量`GROUP BY b.NUM`
        + c.上一步骤结果自关联步骤[a]匹配目标数据——`ON z.MATCH_QTY = LEN(y.BRAND_MAIN) AND z.NUM = y.NUM;`
    + 5.4首轮匹配-顺序检查
        + a.外层循环:`#FIRSTMATCH`→生成循环计数表`#FIRSTMATCH_CHECK_LIST`
        + b.内层循环:逐字过滤，记录比较位置(每次都从上次位置限制开始)→记录变量`@GOODS_INFOCLEAN_SINGLE_SPLIT_LOC`
        + c.检查操作:顺序检查记录不等于商品主品牌字数——删掉`IF (SELECT MAX(N) FROM #FIRSTMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK) != @CHECK`
+ 6.子品牌→重复步骤[5]
+ 7.打标签
    + 7.1主品牌-首字匹配——`SET a.FIRST_STRING_MATCH = 1`
    + 7.2子品牌-首字匹配——`SET a.FIRST_STRING_MATCH = 1`
    + 7.3匹配字符最多——`SET a.QTY_STRING_MATCH = 1`
+ 8.写入品牌信息
    + 8.1首字匹配(不区分主子)
    + 8.2匹配字符最多
+ 9.结果匹配
    + 9.1情况一：首字匹配和匹配字符最多一致+商品名称原样出现——4835+396符合
        + a.[8.1]首字匹配和[8.2]匹配字符最多一致
        + b.[8.1]首字匹配在商品名称原样出现
        `WHERE Brand_MAIN_MATCH_FIRST = Brand_MAIN_MATCH_MOST AND CHARINDEX(Brand_MAIN_MATCH_FIRST, 商品名称, 1) > 0;`
        `WHERE Brand_MAIN_MATCH_FIRST = Brand_MAIN_MATCH_MOST AND CHARINDEX(Brand_SUB_MATCH_FIRST, 商品名称, 1) > 0;`
    + 9.2情况三：首字匹配和匹配字符最多不一致+商品名称原样出现→选取首字匹配——680+152符合
    + 9.3情况四：首字匹配和匹配字符最多不一致+商品名称原样出现→选取匹配字符最多——261+27符合
    + 9.4情况二：首字匹配NULL和匹配字符最多+商品名称原样出现

### 变量信息
+ @NUM——处理目标商品ID`ID16`
    + `SELECT TOP 1 @NUM = ID16 FROM #ID WITH(NOLOCK);`
+ @GDNAME——处理目标商品名称
    + `SELECT TOP 1 @GDNAME = GDNAME FROM #goods_infoclean_single_split WITH(NOLOCK);`
+ @NUM_CHECK——符合首轮匹配结果需要进行顺序检查的变量定位
    + `SELECT TOP 1 @NUM_CHECK = NUM FROM #FIRSTMATCH_CHECK_LIST WITH(NOLOCK);`
+ @NUM_N——逐字过滤变量定位
    + `WHERE NUM = @NUM_CHECK AND N = @NUM_N`
+ @CHECK
+ @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC——限定商品名称集合搜寻的起始位置
    + `SELECT @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC = CHARINDEX(VALUESTRING, @GDNAME, @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC)`

### 代码记录-版本001
```SQL
--↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨[1]
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[导入数据]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[目标数据-20058]
DROP TABLE task_goods_infoclean
--ID16:唯一不重复
SELECT ID16, 品牌, 品牌名称, 主品牌, 子品牌, 品牌厂商, 品牌厂商简称, 大类名称, 中类名称,
       小类名称, 商品名称, N主品牌, N子品牌, 品牌厂商_last, 品牌厂商简称_last
INTO task_goods_infoclean
FROM odsdbtemp.dbo.task_goods_infoclean_original WITH(NOLOCK);
--∷∷∷∷∷∷[INDEX]
--CREATE NONCLUSTERED INDEX IDX_ID ON task_goods_infoclean(ID16 ASC);
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[引用数据-11965]
IF OBJECT_ID('odsdbtemp.dbo.task_goods_Brand_BVName', 'U') IS NOT NULL
DROP TABLE odsdbtemp.dbo.task_goods_Brand_BVName;
SELECT ROW_NUMBER()OVER(ORDER BY(SELECT NULL)) AS NUM,
       N主品牌, N子品牌, 品牌厂商_last, 品牌厂商简称_last, SKU数, 最后一个基本个案
INTO task_goods_Brand_BVName
FROM odsdbtemp.dbo.task_goods_Brand_BVName_original WITH(NOLOCK);
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[引用数据-18513]
IF OBJECT_ID('odsdbtemp.dbo.task_goods_Brand_BVName_WITHSORT', 'U') IS NOT NULL
DROP TABLE odsdbtemp.dbo.task_goods_Brand_BVName_WITHSORT;
SELECT ROW_NUMBER()OVER(ORDER BY(SELECT NULL)) AS NUM,
       N主品牌, N子品牌, 品牌厂商_last, 品牌厂商简称_last, 大类名称, SKU数
INTO task_goods_Brand_BVName_WITHSORT
FROM odsdbtemp.dbo.task_goods_Brand_BVName_WITHSORT_original WITH(NOLOCK);
--↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨[2]
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[源数据文本拆分]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[TallyTable]
IF OBJECT_ID('tempdb.dbo.#TALLY', 'U') IS NOT NULL DROP TABLE #TALLY;
WITH
CTE_1(N) AS (SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL
             SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL
             SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1),
CTE_2(N) AS (SELECT 1 FROM
             CTE_1 AS a WITH(NOLOCK) CROSS JOIN CTE_1 AS b WITH(NOLOCK)),
CTE_3(N) AS (SELECT 1 FROM
             CTE_2 AS a WITH(NOLOCK) CROSS JOIN CTE_2 AS b WITH(NOLOCK))
SELECT TOP 10000
       ROW_NUMBER()OVER(ORDER BY(SELECT NULL)) AS N
INTO #TALLY
FROM CTE_3 WITH(NOLOCK);
--∷∷∷∷∷∷[INDEX]
CREATE CLUSTERED INDEX IDX_CL_N ON #TALLY(N ASC);
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[逐字拆分-商品名称]
IF OBJECT_ID('odsdbtemp.dbo.goods_infoclean_single_split', 'U') IS NOT NULL DROP TABLE goods_infoclean_single_split;
SELECT ID16, N, VALUESTRING, 商品名称 AS GDNAME
INTO goods_infoclean_single_split
FROM task_goods_infoclean AS a WITH(NOLOCK)
CROSS APPLY(SELECT N, SUBSTRING(a.商品名称, N, 1)
            FROM #TALLY WITH(NOLOCK)
            WHERE N <= LEN(a.商品名称)) ITVF(N, VALUESTRING)
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[逐字拆分主品牌-引用数据]
IF OBJECT_ID('odsdbtemp.dbo.task_goods_Brand_BVName_single_split', 'U') IS NOT NULL
DROP TABLE task_goods_Brand_BVName_single_split;
SELECT NUM, N主品牌 AS BRAND_MAIN, N, VALUESTRING
INTO task_goods_Brand_BVName_single_split
FROM task_goods_Brand_BVName AS a WITH(NOLOCK)
CROSS APPLY(SELECT N, SUBSTRING(a.N主品牌, N, 1)
            FROM #TALLY WITH(NOLOCK)
            WHERE N <= LEN(a.N主品牌)) ITVF(N, VALUESTRING)
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[逐字拆分子品牌-引用数据]
IF OBJECT_ID('odsdbtemp.dbo.task_goods_Brand_BVName_single_split_2', 'U') IS NOT NULL
DROP TABLE task_goods_Brand_BVName_single_split_2;
SELECT NUM, N子品牌 AS BRAND_SUB, N, VALUESTRING
INTO task_goods_Brand_BVName_single_split_2
FROM task_goods_Brand_BVName AS a WITH(NOLOCK)
CROSS APPLY(SELECT N, SUBSTRING(a.N子品牌, N, 1)
            FROM #TALLY WITH(NOLOCK)
            WHERE N <= LEN(a.N子品牌)) ITVF(N, VALUESTRING)
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[结果存放]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[存放数据]
SET NOEXEC ON;
IF OBJECT_ID('odsdbtemp.dbo.Brand_BVName_Result', 'U') IS NOT NULL DROP TABLE Brand_BVName_Result;
CREATE TABLE Brand_BVName_Result(NUM            BIGINT,
                                 BRAND_MAIN_SUB NVARCHAR(1000),
                                 N              BIGINT,
                                 VALUESTRING    NVARCHAR(1000),
                                 MAIN_OR_SUB    NVARCHAR(1000),
                                 ID16           INT);
SET NOEXEC OFF;
--↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨[3]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[#ID]
IF OBJECT_ID('tempdb.dbo.#ID', 'U') IS NOT NULL DROP TABLE #ID;
SELECT DISTINCT ID16
INTO #ID
FROM task_goods_infoclean WITH(NOLOCK);
--∷∷∷∷∷∷[INDEX]
CREATE CLUSTERED INDEX IDX_CL_ID16 ON #ID(ID16 ASC);
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[DECLARE]
DECLARE @NUM INT;
DECLARE @GDNAME NVARCHAR(1000);
WHILE EXISTS(SELECT TOP 1 * FROM #ID WITH(NOLOCK))
BEGIN
     --❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀[3]
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[@NUM]
     SELECT TOP 1 @NUM = ID16 FROM #ID WITH(NOLOCK);
     --SELECT TOP 1 @NUM = ID16 FROM #ID WITH(NOLOCK) WHERE ID16 = 82795;
     --SELECT TOP 1 @NUM = ID16 FROM #ID WITH(NOLOCK) WHERE ID16 = 1053;
     --SELECT TOP 1 @NUM = ID16 FROM #ID WITH(NOLOCK) WHERE ID16 = 27983;
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[根据ID16提取单条处理记录]
     IF OBJECT_ID('tempdb.dbo.#goods_infoclean_single_split', 'U') IS NOT NULL DROP TABLE #goods_infoclean_single_split;
     SELECT ID16, N, VALUESTRING, GDNAME
     INTO #goods_infoclean_single_split
     FROM goods_infoclean_single_split WITH(NOLOCK)
     WHERE ID16 = @NUM;
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[@GDNAME]
     SELECT TOP 1 @GDNAME = GDNAME FROM #goods_infoclean_single_split WITH(NOLOCK);
                                                                                             --/*#TEMPORARY#*/SET NOEXEC ON
     --↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[主品牌]
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首轮匹配-集合层面→生成#FIRSTMATCH]
     IF OBJECT_ID('tempdb.dbo.#FIRSTMATCH', 'U') IS NOT NULL DROP TABLE #FIRSTMATCH;
     WITH CTE_MATCH
     AS(SELECT b.NUM, COUNT(b.NUM) AS MATCH_QTY
        FROM #goods_infoclean_single_split              AS a WITH(NOLOCK)/*目标*/
        INNER JOIN task_goods_Brand_BVName_single_split AS b WITH(NOLOCK)/*匹配*/
        ON a.VALUESTRING = b.VALUESTRING
        GROUP BY b.NUM)
     SELECT y.*
     INTO #FIRSTMATCH
     FROM CTE_MATCH                                  AS z WITH(NOLOCK)
     INNER JOIN task_goods_Brand_BVName_single_split AS y WITH(NOLOCK)/*匹配*/
     ON z.MATCH_QTY = LEN(y.BRAND_MAIN) AND z.NUM = y.NUM;
     --∷∷∷∷∷∷[INDEX]
     CREATE CLUSTERED INDEX IDX_CL_NUM ON #FIRSTMATCH(NUM);
     CREATE NONCLUSTERED INDEX IDX_N ON #FIRSTMATCH(N);
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首轮匹配-顺序检查]
     IF OBJECT_ID('tempdb.dbo.#FIRSTMATCH_CHECK_LIST', 'U') IS NOT NULL DROP TABLE #FIRSTMATCH_CHECK_LIST;
     SELECT DISTINCT NUM
     INTO #FIRSTMATCH_CHECK_LIST
     FROM #FIRSTMATCH WITH(NOLOCK);
     --∷∷∷∷∷∷[DECLARE]
     DECLARE @NUM_CHECK INT;
     DECLARE @NUM_N INT;
     DECLARE @CHECK INT;
     DECLARE @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC INT;
     --✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿[2]
     WHILE EXISTS(SELECT TOP 1 * FROM #FIRSTMATCH_CHECK_LIST WITH(NOLOCK))
     BEGIN
          --∷∷∷∷∷∷[SELECT]
          SELECT TOP 1 @NUM_CHECK = NUM FROM #FIRSTMATCH_CHECK_LIST WITH(NOLOCK);
          SELECT @NUM_N = 1;
          SELECT @CHECK = 0;
          SELECT @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC = 0;/*限定商品名称集合搜寻的起始位置*/
                                                                                                  --/*#TEMPORARY#*/SELECT * FROM #FIRSTMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK;
          --✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹[1]
          WHILE @NUM_N <= (SELECT MAX(N) FROM #FIRSTMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK)
          BEGIN
                                                                                                  --/*#TEMPORARY#*/SELECT * FROM #goods_infoclean_single_split WITH(NOLOCK) WHERE N > @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC;
               WITH CTE_FIRSTMATCH
               AS(SELECT NUM, BRAND_MAIN, N, VALUESTRING
                  FROM #FIRSTMATCH WITH(NOLOCK)
                  WHERE NUM = @NUM_CHECK AND N = @NUM_N),/*逐字过滤*/
               CTE_SET
               AS (SELECT COUNT(ID16) AS SET_COUNT
                   FROM #goods_infoclean_single_split AS a WITH(NOLOCK)
                   INNER JOIN CTE_FIRSTMATCH AS b WITH(NOLOCK)
                   ON a.VALUESTRING = b.VALUESTRING
                   WHERE a.N > @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC)
               SELECT @CHECK = @CHECK + (CASE WHEN ISNULL(SET_COUNT, 0) > 0 THEN 1 ELSE 0 END)
               FROM CTE_SET
                                                                                                  --/*#TEMPORARY#*/SELECT @CHECK AS '@CHECK'
               /*记录文字出现位置*/
               SELECT @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC = CHARINDEX(VALUESTRING, @GDNAME, @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC)
               FROM #FIRSTMATCH WITH(NOLOCK)
               WHERE NUM = @NUM_CHECK AND N = @NUM_N;
               /*下个文字*/
               SET @NUM_N = @NUM_N + 1;
          END
          IF(SELECT MAX(N) FROM #FIRSTMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK) != @CHECK
          BEGIN
               DELETE FROM #FIRSTMATCH WHERE NUM = @NUM_CHECK
          END
          --✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹[1]
          /*下个匹配结果*/
          DELETE FROM #FIRSTMATCH_CHECK_LIST WHERE NUM = @NUM_CHECK;
     END
     --✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿[2]
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[结果写入]
     INSERT INTO Brand_BVName_Result(NUM, BRAND_MAIN_SUB, N, VALUESTRING, MAIN_OR_SUB, ID16)
     SELECT NUM, BRAND_MAIN, N, VALUESTRING, '主' AS MAIN_OR_SUB, @NUM /*@NUM = ID16*/
     FROM #FIRSTMATCH WITH(NOLOCK);
                                                                                             --/*#TEMPORARY#*/SET NOEXEC OFF
     --↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[子品牌]
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[二轮匹配-集合层面→生成#SECONDMATCH]
     IF OBJECT_ID('tempdb.dbo.#SECONDMATCH', 'U') IS NOT NULL DROP TABLE #SECONDMATCH;
     WITH CTE_MATCH
     AS(SELECT b.NUM, COUNT(b.NUM) AS MATCH_QTY
        FROM #goods_infoclean_single_split              AS a WITH(NOLOCK)/*目标*/
        INNER JOIN task_goods_Brand_BVName_single_split_2 AS b WITH(NOLOCK)/*匹配*/
        ON a.VALUESTRING = b.VALUESTRING
        GROUP BY b.NUM)
     SELECT y.*
     INTO #SECONDMATCH
     FROM CTE_MATCH                                  AS z WITH(NOLOCK)
     INNER JOIN task_goods_Brand_BVName_single_split_2 AS y WITH(NOLOCK)/*匹配*/
     ON z.MATCH_QTY = LEN(y.BRAND_SUB) AND z.NUM = y.NUM;
     --∷∷∷∷∷∷[INDEX]
     CREATE CLUSTERED INDEX IDX_CL_NUM ON #SECONDMATCH(NUM);
     CREATE NONCLUSTERED INDEX IDX_N ON #SECONDMATCH(N);
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[二轮匹配-顺序检查]
     IF OBJECT_ID('tempdb.dbo.#SECONDMATCH_CHECK_LIST', 'U') IS NOT NULL DROP TABLE #SECONDMATCH_CHECK_LIST;
     SELECT DISTINCT NUM
     INTO #SECONDMATCH_CHECK_LIST
     FROM #SECONDMATCH WITH(NOLOCK);
     --✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿[2]
     WHILE EXISTS(SELECT TOP 1 * FROM #SECONDMATCH_CHECK_LIST WITH(NOLOCK))
     BEGIN
          --∷∷∷∷∷∷[SELECT]
          SELECT TOP 1 @NUM_CHECK = NUM FROM #SECONDMATCH_CHECK_LIST WITH(NOLOCK);
          SELECT @NUM_N = 1;
          SELECT @CHECK = 0;
          SELECT @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC = 0;/*限定商品名称集合搜寻的位置*/
                                                                                                  --/*#TEMPORARY#*/SELECT * FROM #SECONDMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK;
          --✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹[1]
          WHILE @NUM_N <= (SELECT MAX(N) FROM #SECONDMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK)
          BEGIN
                                                                                                  --/*#TEMPORARY#*/SELECT * FROM #goods_infoclean_single_split WITH(NOLOCK) WHERE N > @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC;
               WITH CTE_SECONDMATCH
               AS(SELECT NUM, BRAND_SUB, N, VALUESTRING
                  FROM #SECONDMATCH WITH(NOLOCK)
                  WHERE NUM = @NUM_CHECK AND N = @NUM_N),/*逐字过滤*/
               CTE_SET
               AS (SELECT COUNT(ID16) AS SET_COUNT
                   FROM #goods_infoclean_single_split AS a WITH(NOLOCK)
                   INNER JOIN CTE_SECONDMATCH AS b WITH(NOLOCK)
                   ON a.VALUESTRING = b.VALUESTRING
                   WHERE a.N > @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC)
               SELECT @CHECK = @CHECK + (CASE WHEN ISNULL(SET_COUNT, 0) > 0 THEN 1 ELSE 0 END)
               FROM CTE_SET
                                                                                                  --/*#TEMPORARY#*/SELECT @CHECK AS '@CHECK'
               /*记录文字出现位置*/
               SELECT @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC = CHARINDEX(VALUESTRING, @GDNAME, @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC)
               FROM #SECONDMATCH WITH(NOLOCK)
               WHERE NUM = @NUM_CHECK AND N = @NUM_N
               /*下个文字*/
               SET @NUM_N = @NUM_N + 1;
          END
                                                                                                  --/*#TEMPORARY#*/SELECT @CHECK AS '@CHECK'
          IF(SELECT MAX(N) FROM #SECONDMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK) != @CHECK
          BEGIN
               DELETE FROM #SECONDMATCH WHERE NUM = @NUM_CHECK
          END
          --✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹[1]
          /*下个匹配结果*/
          DELETE FROM #SECONDMATCH_CHECK_LIST WHERE NUM = @NUM_CHECK;
     END
     --✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿[2]
     INSERT INTO Brand_BVName_Result(NUM, BRAND_MAIN_SUB, N, VALUESTRING, MAIN_OR_SUB, ID16)
     SELECT NUM, BRAND_SUB, N, VALUESTRING, '子' AS MAIN_OR_SUB, @NUM /*@NUM = ID16*/
     FROM #SECONDMATCH WITH(NOLOCK);
     /*下一行目标记录*/
     DELETE FROM #ID WHERE ID16 = @NUM
END
--❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀[3]
--↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[改表结构]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[变更存储结构]
ALTER TABLE Brand_BVName_Result ADD FIRST_STRING_MATCH INT;
ALTER TABLE Brand_BVName_Result ADD QTY_STRING_MATCH INT;
ALTER TABLE TASK_GOODS_INFOCLEAN ADD Brand_MAIN_MATCH_FIRST VARCHAR(2000);
ALTER TABLE TASK_GOODS_INFOCLEAN ADD Brand_SUB_MATCH_FIRST VARCHAR(2000);
ALTER TABLE TASK_GOODS_INFOCLEAN ADD Brand_MAIN_MATCH_MOST VARCHAR(2000);
ALTER TABLE TASK_GOODS_INFOCLEAN ADD Brand_SUB_MATCH_MOST VARCHAR(2000);
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[初始化]
UPDATE Brand_BVName_Result SET FIRST_STRING_MATCH = NULL WHERE 1 = 1;
UPDATE Brand_BVName_Result SET QTY_STRING_MATCH = NULL WHERE 1 = 1;
UPDATE task_goods_infoclean SET N主品牌 = NULL WHERE 1 = 1;
UPDATE task_goods_infoclean SET N子品牌 = NULL WHERE 1 = 1;
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[打标签]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[主品牌-首字匹配]
UPDATE a
SET a.FIRST_STRING_MATCH = 1
FROM Brand_BVName_Result                AS a WITH(NOLOCK)
INNER JOIN goods_infoclean_single_split AS b WITH(NOLOCK)
ON a.VALUESTRING = b.VALUESTRING AND a.ID16 = b.ID16
WHERE a.MAIN_OR_SUB = '主'
AND b.N = 1 AND a.N = 1;
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[子品牌-首字匹配]
UPDATE a
SET a.FIRST_STRING_MATCH = 1
FROM Brand_BVName_Result                AS a WITH(NOLOCK)
INNER JOIN goods_infoclean_single_split AS b WITH(NOLOCK)
ON a.VALUESTRING = b.VALUESTRING AND a.ID16 = b.ID16
WHERE a.MAIN_OR_SUB = '子'
AND b.N = 1 AND a.N = 1;
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[匹配字符最多]
WITH CTE_COUNT_N
AS (SELECT ID16, NUM, MAIN_OR_SUB, COUNT(N) AS COUNT_N
    FROM Brand_BVName_Result WITH(NOLOCK)
    GROUP BY ID16, NUM, MAIN_OR_SUB),
    NUM_COUNT_MOST
AS (SELECT ID16, NUM,
    ROW_NUMBER()OVER(PARTITION BY ID16 ORDER BY COUNT_N DESC) AS COUNT_MAX_ORDER
    --MAX(COUNT_N) AS COUNT_N_MAX
    FROM CTE_COUNT_N WITH(NOLOCK))
--SELECT * FROM NUM_COUNT_MOST WHERE id16 = 44;
UPDATE a
SET a.QTY_STRING_MATCH = 1
FROM Brand_BVName_Result  AS a WITH(NOLOCK)
INNER JOIN NUM_COUNT_MOST AS b
ON a.ID16 = b.ID16 AND a.NUM = b.NUM
WHERE a.N = 1 AND b.COUNT_MAX_ORDER = 1;
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[写入品牌信息]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首字匹配(不区分主子)]--7004
UPDATE a
SET a.Brand_MAIN_MATCH_FIRST = c.N主品牌,--FIRST
    a.Brand_SUB_MATCH_FIRST = c.N子品牌--FIRST
FROM task_goods_infoclean AS a WITH(NOLOCK)/*目标表*/
INNER JOIN Brand_BVName_Result AS b WITH(NOLOCK)
ON a.ID16 = b.ID16
LEFT OUTER JOIN task_goods_Brand_BVName AS c WITH(NOLOCK)
ON b.NUM = c.NUM
WHERE b.FIRST_STRING_MATCH = 1;--FIRST
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[匹配字符最多]
UPDATE a
SET a.Brand_MAIN_MATCH_MOST = c.N主品牌,--MOST
    a.Brand_SUB_MATCH_MOST = c.N子品牌--MOST
FROM task_goods_infoclean               AS a WITH(NOLOCK)
INNER JOIN Brand_BVName_Result          AS b WITH(NOLOCK)
ON a.ID16 = b.ID16
LEFT OUTER JOIN task_goods_Brand_BVName AS c WITH(NOLOCK)
ON b.NUM = c.NUM
WHERE b.QTY_STRING_MATCH = 1;
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[最终结果写入]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首字匹配和匹配字符最多一致+商品名称原样出现]--4835+396
--∷∷∷∷∷∷[主:4835]
UPDATE TASK_GOODS_INFOCLEAN
SET N主品牌 = Brand_MAIN_MATCH_FIRST,--FIRST
    N子品牌 = Brand_SUB_MATCH_FIRST--FIRST
FROM TASK_GOODS_INFOCLEAN
WHERE Brand_MAIN_MATCH_FIRST = Brand_MAIN_MATCH_MOST--MAIN
AND   CHARINDEX(Brand_MAIN_MATCH_FIRST, 商品名称, 1) > 0;--MAIN
--∷∷∷∷∷∷[子:396]
UPDATE TASK_GOODS_INFOCLEAN
SET N主品牌 = Brand_MAIN_MATCH_FIRST,--FIRST
    N子品牌 = Brand_SUB_MATCH_FIRST--FIRST
FROM TASK_GOODS_INFOCLEAN
WHERE N主品牌 IS NULL
AND   N子品牌 IS NULL
AND   Brand_SUB_MATCH_FIRST = Brand_SUB_MATCH_MOST--SUB
AND   CHARINDEX(Brand_SUB_MATCH_FIRST, 商品名称, 1) > 0;--SUB
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[逻辑不存在]
--UPDATE TASK_GOODS_INFOCLEAN
--SET N主品牌 = Brand_MAIN_MATCH_FIRST,
--    N子品牌 = Brand_SUB_MATCH_FIRST
--FROM TASK_GOODS_INFOCLEAN
--WHERE N主品牌 IS NULL
--AND   N子品牌 IS NULL
--AND   Brand_MAIN_MATCH_FIRST IS NOT NULL
--AND   Brand_MAIN_MATCH_MOST IS NULL
--AND   CHARINDEX(Brand_MAIN_MATCH_FIRST, 商品名称, 1) > 0;
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首字匹配→逻辑不严谨]
--UPDATE TASK_GOODS_INFOCLEAN
--SET N主品牌 = Brand_MAIN_MATCH_FIRST,--FIRST
--    N子品牌 = Brand_SUB_MATCH_FIRST--FIRST
--FROM TASK_GOODS_INFOCLEAN
--WHERE N主品牌 IS NULL
--AND   N子品牌 IS NULL
--AND   Brand_MAIN_MATCH_FIRST IS NOT NULL;
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首字匹配和匹配字符最多不一致+商品名称原样出现→选取首字匹配]--680+152
--∷∷∷∷∷∷[主:680]
UPDATE TASK_GOODS_INFOCLEAN
SET N主品牌 = Brand_MAIN_MATCH_FIRST,--FIRST
    N子品牌 = Brand_SUB_MATCH_FIRST--FIRST
FROM TASK_GOODS_INFOCLEAN
WHERE N主品牌 IS NULL
AND   N子品牌 IS NULL
AND   Brand_MAIN_MATCH_FIRST != Brand_MAIN_MATCH_MOST
AND   CHARINDEX(Brand_MAIN_MATCH_FIRST, 商品名称, 1) > 0--FIRST--MAIN
--∷∷∷∷∷∷[子:152]
UPDATE TASK_GOODS_INFOCLEAN
SET N主品牌 = Brand_MAIN_MATCH_FIRST,--FIRST
    N子品牌 = Brand_SUB_MATCH_FIRST--FIRST
FROM TASK_GOODS_INFOCLEAN
WHERE N主品牌 IS NULL
AND   N子品牌 IS NULL
AND   Brand_SUB_MATCH_FIRST != Brand_SUB_MATCH_MOST--SUB
AND   CHARINDEX(Brand_SUB_MATCH_FIRST, 商品名称, 1) > 0--FIRST--SUB
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首字匹配和匹配字符最多不一致+商品名称原样出现→选取匹配字符最多]--261+27
--∷∷∷∷∷∷[主:261]
UPDATE task_goods_infoclean
SET N主品牌 = Brand_MAIN_MATCH_MOST,--MOST
    N子品牌 = Brand_SUB_MATCH_MOST--MOST
FROM TASK_GOODS_INFOCLEAN
WHERE N主品牌 IS NULL
AND   N子品牌 IS NULL
AND   Brand_MAIN_MATCH_FIRST != Brand_MAIN_MATCH_MOST
AND   CHARINDEX(Brand_MAIN_MATCH_MOST, 商品名称, 1) > 0;--MOST--MAIN
--∷∷∷∷∷∷[子:27]
UPDATE task_goods_infoclean
SET N主品牌 = Brand_MAIN_MATCH_MOST,--MOST
    N子品牌 = Brand_SUB_MATCH_MOST--MOST
FROM TASK_GOODS_INFOCLEAN
WHERE N主品牌 IS NULL
AND   N子品牌 IS NULL
AND   Brand_MAIN_MATCH_FIRST != Brand_MAIN_MATCH_MOST
AND   CHARINDEX(Brand_SUB_MATCH_MOST, 商品名称, 1) > 0;--MOST--SUB
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首字匹配NULL和匹配字符最多+商品名称原样出现]--2291+1062
--∷∷∷∷∷∷[主:2291]
UPDATE TASK_GOODS_INFOCLEAN
SET N主品牌 = Brand_MAIN_MATCH_MOST,--MOST
    N子品牌 = Brand_SUB_MATCH_MOST--MOST
FROM TASK_GOODS_INFOCLEAN
WHERE N主品牌 IS NULL
AND   N子品牌 IS NULL
AND   Brand_MAIN_MATCH_FIRST IS NULL--MAIN
AND   Brand_MAIN_MATCH_MOST IS NOT NULL--MOST--MAIN
AND   CHARINDEX(Brand_MAIN_MATCH_MOST, 商品名称, 1) > 0;--MOST--MAIN
--∷∷∷∷∷∷[子:1062]
UPDATE TASK_GOODS_INFOCLEAN
SET N主品牌 = Brand_MAIN_MATCH_MOST,--MOST
    N子品牌 = Brand_SUB_MATCH_MOST--MOST
FROM TASK_GOODS_INFOCLEAN
WHERE N主品牌 IS NULL
AND   N子品牌 IS NULL
AND   Brand_SUB_MATCH_FIRST IS NULL--SUB
AND   Brand_SUB_MATCH_MOST IS NOT NULL--MOST--SUB
AND   CHARINDEX(Brand_SUB_MATCH_MOST, 商品名称, 1) > 0;--MOST--SUB
--↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨
SELECT * FROM task_goods_infoclean WITH(NOLOCK) WHERE ID16 = 44;--匹配成功
SELECT * FROM task_goods_infoclean WITH(NOLOCK) WHERE ID16 = 1053;--匹配失败
SELECT * FROM task_goods_infoclean WITH(NOLOCK) WHERE 商品名称 LIKE '%炫迈%';--匹配成功
SELECT COUNT(0) FROM task_goods_infoclean WITH(NOLOCK)WHERE N主品牌 IS NOT NULL;--9704
```

### 代码记录-版本002
```SQL
--↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨[1]
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[导入数据]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[目标数据-20058]
DROP TABLE task_goods_infoclean
--ID16:唯一不重复
SELECT ID16, 品牌, 品牌名称, 主品牌, 子品牌, 品牌厂商, 品牌厂商简称, 大类名称, 中类名称,
       小类名称, 商品名称, N主品牌, N子品牌, 品牌厂商_last, 品牌厂商简称_last
INTO task_goods_infoclean
FROM odsdbtemp.dbo.task_goods_infoclean_original WITH(NOLOCK);
--∷∷∷∷∷∷[INDEX]
--CREATE NONCLUSTERED INDEX IDX_ID ON task_goods_infoclean(ID16 ASC);
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[引用数据-11965]
IF OBJECT_ID('odsdbtemp.dbo.task_goods_Brand_BVName', 'U') IS NOT NULL
DROP TABLE odsdbtemp.dbo.task_goods_Brand_BVName;
SELECT ROW_NUMBER()OVER(ORDER BY(SELECT NULL)) AS NUM,
       N主品牌, N子品牌, 品牌厂商_last, 品牌厂商简称_last, SKU数, 最后一个基本个案
INTO task_goods_Brand_BVName
FROM odsdbtemp.dbo.task_goods_Brand_BVName_original WITH(NOLOCK);
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[引用数据-18513]
IF OBJECT_ID('odsdbtemp.dbo.task_goods_Brand_BVName_WITHSORT', 'U') IS NOT NULL
DROP TABLE odsdbtemp.dbo.task_goods_Brand_BVName_WITHSORT;
SELECT ROW_NUMBER()OVER(ORDER BY(SELECT NULL)) AS NUM,
       N主品牌, N子品牌, 品牌厂商_last, 品牌厂商简称_last, 大类名称, SKU数
INTO task_goods_Brand_BVName_WITHSORT
FROM odsdbtemp.dbo.task_goods_Brand_BVName_WITHSORT_original WITH(NOLOCK);
--↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨[2]
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[源数据文本拆分]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[TallyTable]
IF OBJECT_ID('tempdb.dbo.#TALLY', 'U') IS NOT NULL DROP TABLE #TALLY;
WITH
CTE_1(N) AS (SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL
             SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL
             SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1),
CTE_2(N) AS (SELECT 1 FROM
             CTE_1 AS a WITH(NOLOCK) CROSS JOIN CTE_1 AS b WITH(NOLOCK)),
CTE_3(N) AS (SELECT 1 FROM
             CTE_2 AS a WITH(NOLOCK) CROSS JOIN CTE_2 AS b WITH(NOLOCK))
SELECT TOP 10000
       ROW_NUMBER()OVER(ORDER BY(SELECT NULL)) AS N
INTO #TALLY
FROM CTE_3 WITH(NOLOCK);
--∷∷∷∷∷∷[INDEX]
CREATE CLUSTERED INDEX IDX_CL_N ON #TALLY(N ASC);
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[逐字拆分-商品名称]
IF OBJECT_ID('odsdbtemp.dbo.goods_infoclean_single_split', 'U') IS NOT NULL DROP TABLE goods_infoclean_single_split;
SELECT ID16, N, VALUESTRING, 商品名称 AS GDNAME
INTO goods_infoclean_single_split
FROM task_goods_infoclean AS a WITH(NOLOCK)
CROSS APPLY(SELECT N, SUBSTRING(a.商品名称, N, 1)
            FROM #TALLY WITH(NOLOCK)
            WHERE N <= LEN(a.商品名称)) ITVF(N, VALUESTRING)
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[逐字拆分主品牌-引用数据]
IF OBJECT_ID('odsdbtemp.dbo.task_goods_Brand_BVName_single_split', 'U') IS NOT NULL
DROP TABLE task_goods_Brand_BVName_single_split;
SELECT NUM, N主品牌 AS BRAND_MAIN, N, VALUESTRING
INTO task_goods_Brand_BVName_single_split
FROM task_goods_Brand_BVName AS a WITH(NOLOCK)
CROSS APPLY(SELECT N, SUBSTRING(a.N主品牌, N, 1)
            FROM #TALLY WITH(NOLOCK)
            WHERE N <= LEN(a.N主品牌)) ITVF(N, VALUESTRING)
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[逐字拆分子品牌-引用数据]
IF OBJECT_ID('odsdbtemp.dbo.task_goods_Brand_BVName_single_split_2', 'U') IS NOT NULL
DROP TABLE task_goods_Brand_BVName_single_split_2;
SELECT NUM, N子品牌 AS BRAND_SUB, N, VALUESTRING
INTO task_goods_Brand_BVName_single_split_2
FROM task_goods_Brand_BVName AS a WITH(NOLOCK)
CROSS APPLY(SELECT N, SUBSTRING(a.N子品牌, N, 1)
            FROM #TALLY WITH(NOLOCK)
            WHERE N <= LEN(a.N子品牌)) ITVF(N, VALUESTRING)
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[结果存放]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[存放数据]
SET NOEXEC ON;
IF OBJECT_ID('odsdbtemp.dbo.Brand_BVName_Result', 'U') IS NOT NULL DROP TABLE Brand_BVName_Result;
CREATE TABLE Brand_BVName_Result(NUM            BIGINT,
                                 BRAND_MAIN_SUB NVARCHAR(1000),
                                 N              BIGINT,
                                 VALUESTRING    NVARCHAR(1000),
                                 MAIN_OR_SUB    NVARCHAR(1000),
                                 ID16           INT);
SET NOEXEC OFF;
--↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨[3]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[#ID]
IF OBJECT_ID('tempdb.dbo.#ID', 'U') IS NOT NULL DROP TABLE #ID;
SELECT DISTINCT ID16
INTO #ID
FROM task_goods_infoclean WITH(NOLOCK);
--∷∷∷∷∷∷[INDEX]
CREATE CLUSTERED INDEX IDX_CL_ID16 ON #ID(ID16 ASC);
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[DECLARE]
DECLARE @NUM INT;
DECLARE @GDNAME NVARCHAR(1000);
WHILE EXISTS(SELECT TOP 1 * FROM #ID WITH(NOLOCK))
BEGIN
     --❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀[3]
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[@NUM]
     SELECT TOP 1 @NUM = ID16 FROM #ID WITH(NOLOCK);
     --SELECT TOP 1 @NUM = ID16 FROM #ID WITH(NOLOCK) WHERE ID16 = 82795;
     --SELECT TOP 1 @NUM = ID16 FROM #ID WITH(NOLOCK) WHERE ID16 = 1053;
     --SELECT TOP 1 @NUM = ID16 FROM #ID WITH(NOLOCK) WHERE ID16 = 27983;
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[根据ID16提取单条处理记录]
     IF OBJECT_ID('tempdb.dbo.#goods_infoclean_single_split', 'U') IS NOT NULL DROP TABLE #goods_infoclean_single_split;
     SELECT ID16, N, VALUESTRING, GDNAME
     INTO #goods_infoclean_single_split
     FROM goods_infoclean_single_split WITH(NOLOCK)
     WHERE ID16 = @NUM;
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[@GDNAME]
     SELECT TOP 1 @GDNAME = GDNAME FROM #goods_infoclean_single_split WITH(NOLOCK);
                                                                                             --/*#TEMPORARY#*/SET NOEXEC ON
     --↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[主品牌]
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首轮匹配-集合层面→生成#FIRSTMATCH]
     IF OBJECT_ID('tempdb.dbo.#FIRSTMATCH', 'U') IS NOT NULL DROP TABLE #FIRSTMATCH;
     WITH CTE_MATCH
     AS(SELECT b.NUM, COUNT(b.NUM) AS MATCH_QTY
        FROM #goods_infoclean_single_split              AS a WITH(NOLOCK)/*目标*/
        INNER JOIN task_goods_Brand_BVName_single_split AS b WITH(NOLOCK)/*匹配*/
        ON a.VALUESTRING = b.VALUESTRING
        GROUP BY b.NUM)
     SELECT y.*
     INTO #FIRSTMATCH
     FROM CTE_MATCH                                  AS z WITH(NOLOCK)
     INNER JOIN task_goods_Brand_BVName_single_split AS y WITH(NOLOCK)/*匹配*/
     ON z.MATCH_QTY = LEN(y.BRAND_MAIN) AND z.NUM = y.NUM;
     --∷∷∷∷∷∷[INDEX]
     CREATE CLUSTERED INDEX IDX_CL_NUM ON #FIRSTMATCH(NUM);
     CREATE NONCLUSTERED INDEX IDX_N ON #FIRSTMATCH(N);
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首轮匹配-顺序检查]
     IF OBJECT_ID('tempdb.dbo.#FIRSTMATCH_CHECK_LIST', 'U') IS NOT NULL DROP TABLE #FIRSTMATCH_CHECK_LIST;
     SELECT DISTINCT NUM
     INTO #FIRSTMATCH_CHECK_LIST
     FROM #FIRSTMATCH WITH(NOLOCK);
     --∷∷∷∷∷∷[DECLARE]
     DECLARE @NUM_CHECK INT;
     DECLARE @NUM_N INT;
     DECLARE @CHECK INT;
     DECLARE @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC INT;
     --✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿[2]
     WHILE EXISTS(SELECT TOP 1 * FROM #FIRSTMATCH_CHECK_LIST WITH(NOLOCK))
     BEGIN
          --∷∷∷∷∷∷[SELECT]
          SELECT TOP 1 @NUM_CHECK = NUM FROM #FIRSTMATCH_CHECK_LIST WITH(NOLOCK);
          SELECT @NUM_N = 1;
          SELECT @CHECK = 0;
          SELECT @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC = 0;/*限定商品名称集合搜寻的起始位置*/
                                                                                                  --/*#TEMPORARY#*/SELECT * FROM #FIRSTMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK;
          --✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹[1]
          WHILE @NUM_N <= (SELECT MAX(N) FROM #FIRSTMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK)
          BEGIN
                                                                                                  --/*#TEMPORARY#*/SELECT * FROM #goods_infoclean_single_split WITH(NOLOCK) WHERE N > @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC;
               WITH CTE_FIRSTMATCH
               AS(SELECT NUM, BRAND_MAIN, N, VALUESTRING
                  FROM #FIRSTMATCH WITH(NOLOCK)
                  WHERE NUM = @NUM_CHECK AND N = @NUM_N),/*逐字过滤*/
               CTE_SET
               AS (SELECT COUNT(ID16) AS SET_COUNT
                   FROM #goods_infoclean_single_split AS a WITH(NOLOCK)
                   INNER JOIN CTE_FIRSTMATCH AS b WITH(NOLOCK)
                   ON a.VALUESTRING = b.VALUESTRING
                   WHERE a.N > @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC)
               SELECT @CHECK = @CHECK + (CASE WHEN ISNULL(SET_COUNT, 0) > 0 THEN 1 ELSE 0 END)
               FROM CTE_SET
                                                                                                  --/*#TEMPORARY#*/SELECT @CHECK AS '@CHECK'
               /*记录文字出现位置*/
               SELECT @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC = CHARINDEX(VALUESTRING, @GDNAME, @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC)
               FROM #FIRSTMATCH WITH(NOLOCK)
               WHERE NUM = @NUM_CHECK AND N = @NUM_N;
               /*下个文字*/
               SET @NUM_N = @NUM_N + 1;
          END
          IF(SELECT MAX(N) FROM #FIRSTMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK) != @CHECK
          BEGIN
               DELETE FROM #FIRSTMATCH WHERE NUM = @NUM_CHECK
          END
          --✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹[1]
          /*下个匹配结果*/
          DELETE FROM #FIRSTMATCH_CHECK_LIST WHERE NUM = @NUM_CHECK;
     END
     --✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿[2]
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[结果写入]
     INSERT INTO Brand_BVName_Result(NUM, BRAND_MAIN_SUB, N, VALUESTRING, MAIN_OR_SUB, ID16)
     SELECT NUM, BRAND_MAIN, N, VALUESTRING, '主' AS MAIN_OR_SUB, @NUM /*@NUM = ID16*/
     FROM #FIRSTMATCH WITH(NOLOCK);
                                                                                             --/*#TEMPORARY#*/SET NOEXEC OFF
     --↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[子品牌]
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[二轮匹配-集合层面→生成#SECONDMATCH]
     IF OBJECT_ID('tempdb.dbo.#SECONDMATCH', 'U') IS NOT NULL DROP TABLE #SECONDMATCH;
     WITH CTE_MATCH
     AS(SELECT b.NUM, COUNT(b.NUM) AS MATCH_QTY
        FROM #goods_infoclean_single_split              AS a WITH(NOLOCK)/*目标*/
        INNER JOIN task_goods_Brand_BVName_single_split_2 AS b WITH(NOLOCK)/*匹配*/
        ON a.VALUESTRING = b.VALUESTRING
        GROUP BY b.NUM)
     SELECT y.*
     INTO #SECONDMATCH
     FROM CTE_MATCH                                  AS z WITH(NOLOCK)
     INNER JOIN task_goods_Brand_BVName_single_split_2 AS y WITH(NOLOCK)/*匹配*/
     ON z.MATCH_QTY = LEN(y.BRAND_SUB) AND z.NUM = y.NUM;
     --∷∷∷∷∷∷[INDEX]
     CREATE CLUSTERED INDEX IDX_CL_NUM ON #SECONDMATCH(NUM);
     CREATE NONCLUSTERED INDEX IDX_N ON #SECONDMATCH(N);
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[二轮匹配-顺序检查]
     IF OBJECT_ID('tempdb.dbo.#SECONDMATCH_CHECK_LIST', 'U') IS NOT NULL DROP TABLE #SECONDMATCH_CHECK_LIST;
     SELECT DISTINCT NUM
     INTO #SECONDMATCH_CHECK_LIST
     FROM #SECONDMATCH WITH(NOLOCK);
     --✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿[2]
     WHILE EXISTS(SELECT TOP 1 * FROM #SECONDMATCH_CHECK_LIST WITH(NOLOCK))
     BEGIN
          --∷∷∷∷∷∷[SELECT]
          SELECT TOP 1 @NUM_CHECK = NUM FROM #SECONDMATCH_CHECK_LIST WITH(NOLOCK);
          SELECT @NUM_N = 1;
          SELECT @CHECK = 0;
          SELECT @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC = 0;/*限定商品名称集合搜寻的位置*/
                                                                                                  --/*#TEMPORARY#*/SELECT * FROM #SECONDMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK;
          --✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹[1]
          WHILE @NUM_N <= (SELECT MAX(N) FROM #SECONDMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK)
          BEGIN
                                                                                                  --/*#TEMPORARY#*/SELECT * FROM #goods_infoclean_single_split WITH(NOLOCK) WHERE N > @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC;
               WITH CTE_SECONDMATCH
               AS(SELECT NUM, BRAND_SUB, N, VALUESTRING
                  FROM #SECONDMATCH WITH(NOLOCK)
                  WHERE NUM = @NUM_CHECK AND N = @NUM_N),/*逐字过滤*/
               CTE_SET
               AS (SELECT COUNT(ID16) AS SET_COUNT
                   FROM #goods_infoclean_single_split AS a WITH(NOLOCK)
                   INNER JOIN CTE_SECONDMATCH AS b WITH(NOLOCK)
                   ON a.VALUESTRING = b.VALUESTRING
                   WHERE a.N > @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC)
               SELECT @CHECK = @CHECK + (CASE WHEN ISNULL(SET_COUNT, 0) > 0 THEN 1 ELSE 0 END)
               FROM CTE_SET
                                                                                                  --/*#TEMPORARY#*/SELECT @CHECK AS '@CHECK'
               /*记录文字出现位置*/
               SELECT @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC = CHARINDEX(VALUESTRING, @GDNAME, @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC)
               FROM #SECONDMATCH WITH(NOLOCK)
               WHERE NUM = @NUM_CHECK AND N = @NUM_N
               /*下个文字*/
               SET @NUM_N = @NUM_N + 1;
          END
                                                                                                  --/*#TEMPORARY#*/SELECT @CHECK AS '@CHECK'
          IF(SELECT MAX(N) FROM #SECONDMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK) != @CHECK
          BEGIN
               DELETE FROM #SECONDMATCH WHERE NUM = @NUM_CHECK
          END
          --✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹[1]
          /*下个匹配结果*/
          DELETE FROM #SECONDMATCH_CHECK_LIST WHERE NUM = @NUM_CHECK;
     END
     --✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿[2]
     INSERT INTO Brand_BVName_Result(NUM, BRAND_MAIN_SUB, N, VALUESTRING, MAIN_OR_SUB, ID16)
     SELECT NUM, BRAND_SUB, N, VALUESTRING, '子' AS MAIN_OR_SUB, @NUM /*@NUM = ID16*/
     FROM #SECONDMATCH WITH(NOLOCK);
     /*下一行目标记录*/
     DELETE FROM #ID WHERE ID16 = @NUM
END
--❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀[3]
--↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨[4]
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[改表结构]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[变更存储结构]
ALTER TABLE Brand_BVName_Result ADD FIRST_STRING_MATCH INT;
ALTER TABLE Brand_BVName_Result ADD QTY_STRING_MATCH INT;
ALTER TABLE TASK_GOODS_INFOCLEAN ADD Brand_MAIN_MATCH_FIRST VARCHAR(2000);
ALTER TABLE TASK_GOODS_INFOCLEAN ADD Brand_SUB_MATCH_FIRST VARCHAR(2000);
ALTER TABLE TASK_GOODS_INFOCLEAN ADD Brand_MAIN_MATCH_MOST VARCHAR(2000);
ALTER TABLE TASK_GOODS_INFOCLEAN ADD Brand_SUB_MATCH_MOST VARCHAR(2000);
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[初始化]
UPDATE Brand_BVName_Result SET FIRST_STRING_MATCH = NULL WHERE 1 = 1;
UPDATE Brand_BVName_Result SET QTY_STRING_MATCH = NULL WHERE 1 = 1;
UPDATE task_goods_infoclean SET N主品牌 = NULL WHERE 1 = 1;
UPDATE task_goods_infoclean SET N子品牌 = NULL WHERE 1 = 1;
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[打标签]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[主品牌-首字匹配]
UPDATE a
SET a.FIRST_STRING_MATCH = 1
FROM Brand_BVName_Result                AS a WITH(NOLOCK)
INNER JOIN goods_infoclean_single_split AS b WITH(NOLOCK)
ON a.VALUESTRING = b.VALUESTRING AND a.ID16 = b.ID16
WHERE a.MAIN_OR_SUB = '主'
AND b.N = 1 AND a.N = 1;
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[子品牌-首字匹配]
UPDATE a
SET a.FIRST_STRING_MATCH = 1
FROM Brand_BVName_Result                AS a WITH(NOLOCK)
INNER JOIN goods_infoclean_single_split AS b WITH(NOLOCK)
ON a.VALUESTRING = b.VALUESTRING AND a.ID16 = b.ID16
WHERE a.MAIN_OR_SUB = '子'
AND b.N = 1 AND a.N = 1;
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[匹配字符最多]
WITH CTE_COUNT_N
AS (SELECT ID16, NUM, MAIN_OR_SUB, COUNT(N) AS COUNT_N
    FROM Brand_BVName_Result WITH(NOLOCK)
    GROUP BY ID16, NUM, MAIN_OR_SUB),
    NUM_COUNT_MOST
AS (SELECT ID16, NUM,
    ROW_NUMBER()OVER(PARTITION BY ID16 ORDER BY COUNT_N DESC) AS COUNT_MAX_ORDER
    --MAX(COUNT_N) AS COUNT_N_MAX
    FROM CTE_COUNT_N WITH(NOLOCK))
--SELECT * FROM NUM_COUNT_MOST WHERE id16 = 44;
UPDATE a
SET a.QTY_STRING_MATCH = 1
FROM Brand_BVName_Result  AS a WITH(NOLOCK)
INNER JOIN NUM_COUNT_MOST AS b
ON a.ID16 = b.ID16 AND a.NUM = b.NUM
WHERE a.N = 1 AND b.COUNT_MAX_ORDER = 1;
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[写入品牌信息]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首字匹配(不区分主子)]--7004
UPDATE a
SET a.Brand_MAIN_MATCH_FIRST = c.N主品牌,--FIRST
    a.Brand_SUB_MATCH_FIRST = c.N子品牌--FIRST
FROM task_goods_infoclean AS a WITH(NOLOCK)/*目标表*/
INNER JOIN Brand_BVName_Result AS b WITH(NOLOCK)
ON a.ID16 = b.ID16
LEFT OUTER JOIN task_goods_Brand_BVName AS c WITH(NOLOCK)
ON b.NUM = c.NUM
WHERE b.FIRST_STRING_MATCH = 1;--FIRST
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[匹配字符最多]
UPDATE a
SET a.Brand_MAIN_MATCH_MOST = c.N主品牌,--MOST
    a.Brand_SUB_MATCH_MOST = c.N子品牌--MOST
FROM task_goods_infoclean               AS a WITH(NOLOCK)
INNER JOIN Brand_BVName_Result          AS b WITH(NOLOCK)
ON a.ID16 = b.ID16
LEFT OUTER JOIN task_goods_Brand_BVName AS c WITH(NOLOCK)
ON b.NUM = c.NUM
WHERE b.QTY_STRING_MATCH = 1;
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[最终结果写入]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首字匹配和匹配字符最多一致+商品名称原样出现]--4835+396
--∷∷∷∷∷∷[主:4835]
UPDATE TASK_GOODS_INFOCLEAN
SET N主品牌 = Brand_MAIN_MATCH_FIRST,--FIRST
    N子品牌 = Brand_SUB_MATCH_FIRST--FIRST
FROM TASK_GOODS_INFOCLEAN
WHERE Brand_MAIN_MATCH_FIRST = Brand_MAIN_MATCH_MOST--MAIN
AND   CHARINDEX(Brand_MAIN_MATCH_FIRST, 商品名称, 1) > 0;--MAIN
--∷∷∷∷∷∷[子:396]
UPDATE TASK_GOODS_INFOCLEAN
SET N主品牌 = Brand_MAIN_MATCH_FIRST,--FIRST
    N子品牌 = Brand_SUB_MATCH_FIRST--FIRST
FROM TASK_GOODS_INFOCLEAN
WHERE N主品牌 IS NULL
AND   N子品牌 IS NULL
AND   Brand_SUB_MATCH_FIRST = Brand_SUB_MATCH_MOST--SUB
AND   CHARINDEX(Brand_SUB_MATCH_FIRST, 商品名称, 1) > 0;--SUB
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[逻辑不存在]
--UPDATE TASK_GOODS_INFOCLEAN
--SET N主品牌 = Brand_MAIN_MATCH_FIRST,
--    N子品牌 = Brand_SUB_MATCH_FIRST
--FROM TASK_GOODS_INFOCLEAN
--WHERE N主品牌 IS NULL
--AND   N子品牌 IS NULL
--AND   Brand_MAIN_MATCH_FIRST IS NOT NULL
--AND   Brand_MAIN_MATCH_MOST IS NULL
--AND   CHARINDEX(Brand_MAIN_MATCH_FIRST, 商品名称, 1) > 0;
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首字匹配→逻辑不严谨]
--UPDATE TASK_GOODS_INFOCLEAN
--SET N主品牌 = Brand_MAIN_MATCH_FIRST,--FIRST
--    N子品牌 = Brand_SUB_MATCH_FIRST--FIRST
--FROM TASK_GOODS_INFOCLEAN
--WHERE N主品牌 IS NULL
--AND   N子品牌 IS NULL
--AND   Brand_MAIN_MATCH_FIRST IS NOT NULL;
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首字匹配和匹配字符最多不一致+商品名称原样出现→选取首字匹配]--680+152
--∷∷∷∷∷∷[主:680]
UPDATE TASK_GOODS_INFOCLEAN
SET N主品牌 = Brand_MAIN_MATCH_FIRST,--FIRST
    N子品牌 = Brand_SUB_MATCH_FIRST--FIRST
FROM TASK_GOODS_INFOCLEAN
WHERE N主品牌 IS NULL
AND   N子品牌 IS NULL
AND   Brand_MAIN_MATCH_FIRST != Brand_MAIN_MATCH_MOST
AND   CHARINDEX(Brand_MAIN_MATCH_FIRST, 商品名称, 1) > 0--FIRST--MAIN
--∷∷∷∷∷∷[子:152]
UPDATE TASK_GOODS_INFOCLEAN
SET N主品牌 = Brand_MAIN_MATCH_FIRST,--FIRST
    N子品牌 = Brand_SUB_MATCH_FIRST--FIRST
FROM TASK_GOODS_INFOCLEAN
WHERE N主品牌 IS NULL
AND   N子品牌 IS NULL
AND   Brand_SUB_MATCH_FIRST != Brand_SUB_MATCH_MOST--SUB
AND   CHARINDEX(Brand_SUB_MATCH_FIRST, 商品名称, 1) > 0--FIRST--SUB
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首字匹配和匹配字符最多不一致+商品名称原样出现→选取匹配字符最多]--261+27
--∷∷∷∷∷∷[主:261]
UPDATE task_goods_infoclean
SET N主品牌 = Brand_MAIN_MATCH_MOST,--MOST
    N子品牌 = Brand_SUB_MATCH_MOST--MOST
FROM TASK_GOODS_INFOCLEAN
WHERE N主品牌 IS NULL
AND   N子品牌 IS NULL
AND   Brand_MAIN_MATCH_FIRST != Brand_MAIN_MATCH_MOST
AND   CHARINDEX(Brand_MAIN_MATCH_MOST, 商品名称, 1) > 0;--MOST--MAIN
--∷∷∷∷∷∷[子:27]
UPDATE task_goods_infoclean
SET N主品牌 = Brand_MAIN_MATCH_MOST,--MOST
    N子品牌 = Brand_SUB_MATCH_MOST--MOST
FROM TASK_GOODS_INFOCLEAN
WHERE N主品牌 IS NULL
AND   N子品牌 IS NULL
AND   Brand_MAIN_MATCH_FIRST != Brand_MAIN_MATCH_MOST
AND   CHARINDEX(Brand_SUB_MATCH_MOST, 商品名称, 1) > 0;--MOST--SUB
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首字匹配NULL和匹配字符最多+商品名称原样出现]--2291+1062
--∷∷∷∷∷∷[主:2291]
UPDATE TASK_GOODS_INFOCLEAN
SET N主品牌 = Brand_MAIN_MATCH_MOST,--MOST
    N子品牌 = Brand_SUB_MATCH_MOST--MOST
FROM TASK_GOODS_INFOCLEAN
WHERE N主品牌 IS NULL
AND   N子品牌 IS NULL
AND   Brand_MAIN_MATCH_FIRST IS NULL--MAIN
AND   Brand_MAIN_MATCH_MOST IS NOT NULL--MOST--MAIN
AND   CHARINDEX(Brand_MAIN_MATCH_MOST, 商品名称, 1) > 0;--MOST--MAIN
--∷∷∷∷∷∷[子:1062]
UPDATE TASK_GOODS_INFOCLEAN
SET N主品牌 = Brand_MAIN_MATCH_MOST,--MOST
    N子品牌 = Brand_SUB_MATCH_MOST--MOST
FROM TASK_GOODS_INFOCLEAN
WHERE N主品牌 IS NULL
AND   N子品牌 IS NULL
AND   Brand_SUB_MATCH_FIRST IS NULL--SUB
AND   Brand_SUB_MATCH_MOST IS NOT NULL--MOST--SUB
AND   CHARINDEX(Brand_SUB_MATCH_MOST, 商品名称, 1) > 0;--MOST--SUB
--↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨[5]
SELECT * FROM task_goods_infoclean WITH(NOLOCK) WHERE ID16 = 44;--匹配成功
SELECT * FROM task_goods_infoclean WITH(NOLOCK) WHERE ID16 = 1053;--匹配失败
SELECT * FROM task_goods_infoclean WITH(NOLOCK) WHERE 商品名称 LIKE '%炫迈%';--匹配成功
SELECT COUNT(0) FROM task_goods_infoclean WITH(NOLOCK)WHERE N主品牌 IS NOT NULL;--9704
```

## 主线任务-20220616
### 逻辑压缩
1. 沿用版本002处理逻辑
2. 把符合条件的范围限定为临近行已经确认的上一条记录或下一条记录——组成集合`临近确认集合`
    1. 目标行向上选取邻近主品牌不为空一行
    2. 目标行向下选取邻近主品牌不为空一行
3. 步骤[2]集合匹配处理——<strong><font color=#FF4500>临近确认集合</font></strong>
    1. 主品牌等于首字匹配+子品牌等于首字匹配<strong><font color=#E6E022>∩</font></strong>`临近确认集合`
        1. `ON b.N主品牌 = a.Brand_MAIN_MATCH_FIRST AND b.N子品牌 = a.Brand_SUB_MATCH_FIRST`
    2. 主品牌等于匹配字符最多+子品牌等于匹配字符最多<strong><font color=#E6E022>∩</font></strong>`临近确认集合`
        1. `ON b.N主品牌 = a.Brand_MAIN_MATCH_MOST AND b.N子品牌 = a.Brand_SUB_MATCH_MOST`

### 代码记录
```SQL
--↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨[1]
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[导入数据]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[目标数据-54110]
SELECT * INTO TASK_BRAND_MATCH_ORIGINAL FROM TASK_BRAND_MATCH WITH(NOLOCK); --54110
CREATE CLUSTERED INDEX IDX_CL_ID01 ON TASK_BRAND_MATCH_ORIGINAL(ID01);
--∷∷∷∷∷∷[改表结构]
ALTER TABLE TASK_BRAND_MATCH ADD ID99 INT;
UPDATE TASK_BRAND_MATCH SET ID99 = RIGHT(ID01, LEN(ID01) - 1) WHERE 1 = 1;
CREATE CLUSTERED INDEX IDX_CL_ID99 ON TASK_BRAND_MATCH(ID99 ASC);
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[引用数据-11965]
IF OBJECT_ID('odsdbtemp.dbo.task_goods_Brand_BVName', 'U') IS NOT NULL
DROP TABLE odsdbtemp.dbo.task_goods_Brand_BVName;
SELECT ROW_NUMBER()OVER(ORDER BY(SELECT NULL)) AS NUM,
       N主品牌, N子品牌, 品牌厂商_last, 品牌厂商简称_last, SKU数, 最后一个基本个案
INTO task_goods_Brand_BVName
FROM odsdbtemp.dbo.task_goods_Brand_BVName_original WITH(NOLOCK);
--↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨[2]
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[源数据文本拆分]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[TallyTable]
IF OBJECT_ID('tempdb.dbo.#TALLY', 'U') IS NOT NULL DROP TABLE #TALLY;
WITH
CTE_1(N) AS (SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL
             SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL
             SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1 UNION ALL SELECT 1),
CTE_2(N) AS (SELECT 1 FROM
             CTE_1 AS a WITH(NOLOCK) CROSS JOIN CTE_1 AS b WITH(NOLOCK)),
CTE_3(N) AS (SELECT 1 FROM
             CTE_2 AS a WITH(NOLOCK) CROSS JOIN CTE_2 AS b WITH(NOLOCK))
SELECT TOP 10000
       ROW_NUMBER()OVER(ORDER BY(SELECT NULL)) AS N
INTO #TALLY
FROM CTE_3 WITH(NOLOCK);
--∷∷∷∷∷∷[INDEX]
CREATE CLUSTERED INDEX IDX_CL_N ON #TALLY(N ASC);
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[逐字拆分-商品名称]
IF OBJECT_ID('odsdbtemp.dbo.TASK_BRAND_MATCH_SINGLE_SPLIT', 'U') IS NOT NULL DROP TABLE TASK_BRAND_MATCH_SINGLE_SPLIT;
SELECT ID01, ID16, N, VALUESTRING, N商品名称 AS GDNAME
INTO TASK_BRAND_MATCH_SINGLE_SPLIT
FROM TASK_BRAND_MATCH AS a WITH(NOLOCK)
CROSS APPLY(SELECT N, SUBSTRING(a.N商品名称, N, 1)
            FROM #TALLY WITH(NOLOCK)
            WHERE N <= LEN(a.N商品名称)) ITVF(N, VALUESTRING);
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[逐字拆分主品牌-引用数据]
IF OBJECT_ID('odsdbtemp.dbo.task_goods_Brand_BVName_single_split', 'U') IS NOT NULL
DROP TABLE task_goods_Brand_BVName_single_split;
SELECT NUM, N主品牌 AS BRAND_MAIN, N, VALUESTRING
INTO task_goods_Brand_BVName_single_split
FROM task_goods_Brand_BVName AS a WITH(NOLOCK)
CROSS APPLY(SELECT N, SUBSTRING(a.N主品牌, N, 1)
            FROM #TALLY WITH(NOLOCK)
            WHERE N <= LEN(a.N主品牌)) ITVF(N, VALUESTRING)
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[逐字拆分主品牌-引用数据]--MAIN
IF OBJECT_ID('odsdbtemp.dbo.task_goods_Brand_BVName_single_split', 'U') IS NOT NULL
DROP TABLE task_goods_Brand_BVName_single_split;
SELECT NUM, N主品牌 AS BRAND_MAIN, N, VALUESTRING
INTO task_goods_Brand_BVName_single_split
FROM task_goods_Brand_BVName AS a WITH(NOLOCK)
CROSS APPLY(SELECT N, SUBSTRING(a.N主品牌, N, 1)
            FROM #TALLY WITH(NOLOCK)
            WHERE N <= LEN(a.N主品牌)) ITVF(N, VALUESTRING)
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[逐字拆分子品牌-引用数据]--SUB
IF OBJECT_ID('odsdbtemp.dbo.task_goods_Brand_BVName_single_split_2', 'U') IS NOT NULL
DROP TABLE task_goods_Brand_BVName_single_split_2;
SELECT NUM, N子品牌 AS BRAND_SUB, N, VALUESTRING
INTO task_goods_Brand_BVName_single_split_2
FROM task_goods_Brand_BVName AS a WITH(NOLOCK)
CROSS APPLY(SELECT N, SUBSTRING(a.N子品牌, N, 1)
            FROM #TALLY WITH(NOLOCK)
            WHERE N <= LEN(a.N子品牌)) ITVF(N, VALUESTRING)
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[结果存放]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[存放数据]
SET NOEXEC ON;
IF OBJECT_ID('odsdbtemp.dbo.Brand_BVName_Result_AGAIN', 'U') IS NOT NULL DROP TABLE Brand_BVName_Result_AGAIN;
CREATE TABLE Brand_BVName_Result_AGAIN(ID01 NVARCHAR(1000),
                                       NUM BIGINT,
                                       BRAND_MAIN_SUB NVARCHAR(1000),
                                       N              BIGINT,
                                       VALUESTRING    NVARCHAR(1000),
                                       MAIN_OR_SUB    NVARCHAR(1000),
                                       ID16           INT);
SET NOEXEC OFF;
--↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨[3]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[#ID]
IF OBJECT_ID('tempdb.dbo.#ID', 'U') IS NOT NULL DROP TABLE #ID;
SELECT DISTINCT ID16
INTO #ID
FROM TASK_BRAND_MATCH_SINGLE_SPLIT WITH(NOLOCK);
--∷∷∷∷∷∷[INDEX]
CREATE CLUSTERED INDEX IDX_CL_ID16 ON #ID(ID16 ASC);
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[DECLARE]
DECLARE @NUM INT;
DECLARE @GDNAME NVARCHAR(1000);
WHILE EXISTS(SELECT TOP 1 * FROM #ID WITH(NOLOCK))
BEGIN
     --❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀[3]
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[@NUM]
     SELECT TOP 1 @NUM = ID16 FROM #ID WITH(NOLOCK);
     --SELECT TOP 1 @NUM = ID16 FROM #ID WITH(NOLOCK) WHERE ID16 = 82795;
     --SELECT TOP 1 @NUM = ID16 FROM #ID WITH(NOLOCK) WHERE ID16 = 1053;
     --SELECT TOP 1 @NUM = ID16 FROM #ID WITH(NOLOCK) WHERE ID16 = 27983;
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[根据ID16提取单条处理记录]
     IF OBJECT_ID('tempdb.dbo.#TASK_BRAND_MATCH_SINGLE_SPLIT', 'U') IS NOT NULL DROP TABLE #TASK_BRAND_MATCH_SINGLE_SPLIT;
     SELECT ID16, N, VALUESTRING, GDNAME
     INTO #TASK_BRAND_MATCH_SINGLE_SPLIT
     FROM TASK_BRAND_MATCH_SINGLE_SPLIT WITH(NOLOCK)
     WHERE ID16 = @NUM;
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[@GDNAME]
     SELECT TOP 1 @GDNAME = GDNAME FROM #TASK_BRAND_MATCH_SINGLE_SPLIT WITH(NOLOCK);
                                                                                             --/*#TEMPORARY#*/SET NOEXEC ON
     --↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[主品牌]
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首轮匹配-集合层面→生成#FIRSTMATCH]
     IF OBJECT_ID('tempdb.dbo.#FIRSTMATCH', 'U') IS NOT NULL DROP TABLE #FIRSTMATCH;
     WITH CTE_MATCH
     AS(SELECT b.NUM, COUNT(b.NUM) AS MATCH_QTY
        FROM #TASK_BRAND_MATCH_SINGLE_SPLIT              AS a WITH(NOLOCK)/*目标*/
        INNER JOIN task_goods_Brand_BVName_single_split AS b WITH(NOLOCK)/*匹配*/
        ON a.VALUESTRING = b.VALUESTRING
        GROUP BY b.NUM)
     SELECT y.*
     INTO #FIRSTMATCH
     FROM CTE_MATCH                                  AS z WITH(NOLOCK)
     INNER JOIN task_goods_Brand_BVName_single_split AS y WITH(NOLOCK)/*匹配*/
     ON z.MATCH_QTY = LEN(y.BRAND_MAIN) AND z.NUM = y.NUM;
     --∷∷∷∷∷∷[INDEX]
     CREATE CLUSTERED INDEX IDX_CL_NUM ON #FIRSTMATCH(NUM);
     CREATE NONCLUSTERED INDEX IDX_N ON #FIRSTMATCH(N);
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首轮匹配-顺序检查]
     IF OBJECT_ID('tempdb.dbo.#FIRSTMATCH_CHECK_LIST', 'U') IS NOT NULL DROP TABLE #FIRSTMATCH_CHECK_LIST;
     SELECT DISTINCT NUM
     INTO #FIRSTMATCH_CHECK_LIST
     FROM #FIRSTMATCH WITH(NOLOCK);
     --∷∷∷∷∷∷[DECLARE]
     DECLARE @NUM_CHECK INT;
     DECLARE @NUM_N INT;
     DECLARE @CHECK INT;
     DECLARE @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC INT;
     --✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿[2]
     WHILE EXISTS(SELECT TOP 1 * FROM #FIRSTMATCH_CHECK_LIST WITH(NOLOCK))
     BEGIN
          --∷∷∷∷∷∷[SELECT]
          SELECT TOP 1 @NUM_CHECK = NUM FROM #FIRSTMATCH_CHECK_LIST WITH(NOLOCK);
          SELECT @NUM_N = 1;
          SELECT @CHECK = 0;
          SELECT @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC = 0;/*限定商品名称集合搜寻的起始位置*/
                                                                                                  --/*#TEMPORARY#*/SELECT * FROM #FIRSTMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK;
          --✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹[1]
          WHILE @NUM_N <= (SELECT MAX(N) FROM #FIRSTMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK)
          BEGIN
                                                                                                  --/*#TEMPORARY#*/SELECT * FROM #TASK_BRAND_MATCH_SINGLE_SPLIT WITH(NOLOCK) WHERE N > @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC;
               WITH CTE_FIRSTMATCH
               AS(SELECT NUM, BRAND_MAIN, N, VALUESTRING
                  FROM #FIRSTMATCH WITH(NOLOCK)
                  WHERE NUM = @NUM_CHECK AND N = @NUM_N),/*逐字过滤*/
               CTE_SET
               AS (SELECT COUNT(ID16) AS SET_COUNT
                   FROM #TASK_BRAND_MATCH_SINGLE_SPLIT AS a WITH(NOLOCK)
                   INNER JOIN CTE_FIRSTMATCH AS b WITH(NOLOCK)
                   ON a.VALUESTRING = b.VALUESTRING
                   WHERE a.N > @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC)
               SELECT @CHECK = @CHECK + (CASE WHEN ISNULL(SET_COUNT, 0) > 0 THEN 1 ELSE 0 END)
               FROM CTE_SET
                                                                                                  --/*#TEMPORARY#*/SELECT @CHECK AS '@CHECK'
               /*记录文字出现位置*/
               SELECT @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC = CHARINDEX(VALUESTRING, @GDNAME, @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC)
               FROM #FIRSTMATCH WITH(NOLOCK)
               WHERE NUM = @NUM_CHECK AND N = @NUM_N;
               /*下个文字*/
               SET @NUM_N = @NUM_N + 1;
          END
          IF(SELECT MAX(N) FROM #FIRSTMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK) != @CHECK
          BEGIN
               DELETE FROM #FIRSTMATCH WHERE NUM = @NUM_CHECK
          END
          --✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹[1]
          /*下个匹配结果*/
          DELETE FROM #FIRSTMATCH_CHECK_LIST WHERE NUM = @NUM_CHECK;
     END
     --✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿[2]
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[结果写入]
     INSERT INTO Brand_BVName_Result_AGAIN(NUM, BRAND_MAIN_SUB, N, VALUESTRING, MAIN_OR_SUB, ID16)
     SELECT NUM, BRAND_MAIN, N, VALUESTRING, '主' AS MAIN_OR_SUB, @NUM /*@NUM = ID16*/
     FROM #FIRSTMATCH WITH(NOLOCK);
                                                                                             --/*#TEMPORARY#*/SET NOEXEC OFF
     --↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[子品牌]
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[二轮匹配-集合层面→生成#SECONDMATCH]
     IF OBJECT_ID('tempdb.dbo.#SECONDMATCH', 'U') IS NOT NULL DROP TABLE #SECONDMATCH;
     WITH CTE_MATCH
     AS(SELECT b.NUM, COUNT(b.NUM) AS MATCH_QTY
        FROM #TASK_BRAND_MATCH_SINGLE_SPLIT              AS a WITH(NOLOCK)/*目标*/
        INNER JOIN task_goods_Brand_BVName_single_split_2 AS b WITH(NOLOCK)/*匹配*/
        ON a.VALUESTRING = b.VALUESTRING
        GROUP BY b.NUM)
     SELECT y.*
     INTO #SECONDMATCH
     FROM CTE_MATCH                                  AS z WITH(NOLOCK)
     INNER JOIN task_goods_Brand_BVName_single_split_2 AS y WITH(NOLOCK)/*匹配*/
     ON z.MATCH_QTY = LEN(y.BRAND_SUB) AND z.NUM = y.NUM;
     --∷∷∷∷∷∷[INDEX]
     CREATE CLUSTERED INDEX IDX_CL_NUM ON #SECONDMATCH(NUM);
     CREATE NONCLUSTERED INDEX IDX_N ON #SECONDMATCH(N);
     --⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[二轮匹配-顺序检查]
     IF OBJECT_ID('tempdb.dbo.#SECONDMATCH_CHECK_LIST', 'U') IS NOT NULL DROP TABLE #SECONDMATCH_CHECK_LIST;
     SELECT DISTINCT NUM
     INTO #SECONDMATCH_CHECK_LIST
     FROM #SECONDMATCH WITH(NOLOCK);
     --✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿[2]
     WHILE EXISTS(SELECT TOP 1 * FROM #SECONDMATCH_CHECK_LIST WITH(NOLOCK))
     BEGIN
          --∷∷∷∷∷∷[SELECT]
          SELECT TOP 1 @NUM_CHECK = NUM FROM #SECONDMATCH_CHECK_LIST WITH(NOLOCK);
          SELECT @NUM_N = 1;
          SELECT @CHECK = 0;
          SELECT @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC = 0;/*限定商品名称集合搜寻的位置*/
                                                                                                  --/*#TEMPORARY#*/SELECT * FROM #SECONDMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK;
          --✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹[1]
          WHILE @NUM_N <= (SELECT MAX(N) FROM #SECONDMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK)
          BEGIN
                                                                                                  --/*#TEMPORARY#*/SELECT * FROM #TASK_BRAND_MATCH_SINGLE_SPLIT WITH(NOLOCK) WHERE N > @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC;
               WITH CTE_SECONDMATCH
               AS(SELECT NUM, BRAND_SUB, N, VALUESTRING
                  FROM #SECONDMATCH WITH(NOLOCK)
                  WHERE NUM = @NUM_CHECK AND N = @NUM_N),/*逐字过滤*/
               CTE_SET
               AS (SELECT COUNT(ID16) AS SET_COUNT
                   FROM #TASK_BRAND_MATCH_SINGLE_SPLIT AS a WITH(NOLOCK)
                   INNER JOIN CTE_SECONDMATCH AS b WITH(NOLOCK)
                   ON a.VALUESTRING = b.VALUESTRING
                   WHERE a.N > @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC)
               SELECT @CHECK = @CHECK + (CASE WHEN ISNULL(SET_COUNT, 0) > 0 THEN 1 ELSE 0 END)
               FROM CTE_SET
                                                                                                  --/*#TEMPORARY#*/SELECT @CHECK AS '@CHECK'
               /*记录文字出现位置*/
               SELECT @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC = CHARINDEX(VALUESTRING, @GDNAME, @GOODS_INFOCLEAN_SINGLE_SPLIT_LOC)
               FROM #SECONDMATCH WITH(NOLOCK)
               WHERE NUM = @NUM_CHECK AND N = @NUM_N
               /*下个文字*/
               SET @NUM_N = @NUM_N + 1;
          END
                                                                                                  --/*#TEMPORARY#*/SELECT @CHECK AS '@CHECK'
          IF(SELECT MAX(N) FROM #SECONDMATCH WITH(NOLOCK) WHERE NUM = @NUM_CHECK) != @CHECK
          BEGIN
               DELETE FROM #SECONDMATCH WHERE NUM = @NUM_CHECK
          END
          --✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹[1]
          /*下个匹配结果*/
          DELETE FROM #SECONDMATCH_CHECK_LIST WHERE NUM = @NUM_CHECK;
     END
     --✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿✿[2]
     INSERT INTO Brand_BVName_Result_AGAIN(NUM, BRAND_MAIN_SUB, N, VALUESTRING, MAIN_OR_SUB, ID16)
     SELECT NUM, BRAND_SUB, N, VALUESTRING, '子' AS MAIN_OR_SUB, @NUM /*@NUM = ID16*/
     FROM #SECONDMATCH WITH(NOLOCK);
     /*下一行目标记录*/
     DELETE FROM #ID WHERE ID16 = @NUM
END
--❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀❀[3]
--↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨↨[4]
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[改表结构]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[变更存储结构]
ALTER TABLE Brand_BVName_Result_AGAIN ADD FIRST_STRING_MATCH INT;
ALTER TABLE Brand_BVName_Result_AGAIN ADD QTY_STRING_MATCH INT;
ALTER TABLE TASK_BRAND_MATCH ADD Brand_MAIN_MATCH_FIRST VARCHAR(2000);
ALTER TABLE TASK_BRAND_MATCH ADD Brand_SUB_MATCH_FIRST VARCHAR(2000);
ALTER TABLE TASK_BRAND_MATCH ADD Brand_MAIN_MATCH_MOST VARCHAR(2000);
ALTER TABLE TASK_BRAND_MATCH ADD Brand_SUB_MATCH_MOST VARCHAR(2000);
ALTER TABLE TASK_BRAND_MATCH ADD Brand_NULL INT;
ALTER TABLE TASK_BRAND_MATCH ADD MAKER_NULL INT;
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[初始化]
UPDATE Brand_BVName_Result_AGAIN SET FIRST_STRING_MATCH = NULL WHERE 1 = 1;
UPDATE Brand_BVName_Result_AGAIN SET QTY_STRING_MATCH = NULL WHERE 1 = 1;
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[打标签]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[主品牌-首字匹配]
UPDATE a
SET a.FIRST_STRING_MATCH = 1
FROM Brand_BVName_Result_AGAIN                AS a WITH(NOLOCK)
INNER JOIN goods_infoclean_single_split AS b WITH(NOLOCK)
ON a.VALUESTRING = b.VALUESTRING AND a.ID16 = b.ID16
WHERE a.MAIN_OR_SUB = '主'
AND b.N = 1 AND a.N = 1;
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[子品牌-首字匹配]
UPDATE a
SET a.FIRST_STRING_MATCH = 1
FROM Brand_BVName_Result_AGAIN                AS a WITH(NOLOCK)
INNER JOIN goods_infoclean_single_split AS b WITH(NOLOCK)
ON a.VALUESTRING = b.VALUESTRING AND a.ID16 = b.ID16
WHERE a.MAIN_OR_SUB = '子'
AND b.N = 1 AND a.N = 1;
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[匹配字符最多]
WITH CTE_COUNT_N
AS (SELECT ID16, NUM, MAIN_OR_SUB, COUNT(N) AS COUNT_N
    FROM Brand_BVName_Result_AGAIN WITH(NOLOCK)
    GROUP BY ID16, NUM, MAIN_OR_SUB),
    NUM_COUNT_MOST
AS (SELECT ID16, NUM,
    ROW_NUMBER()OVER(PARTITION BY ID16 ORDER BY COUNT_N DESC) AS COUNT_MAX_ORDER
    --MAX(COUNT_N) AS COUNT_N_MAX
    FROM CTE_COUNT_N WITH(NOLOCK))
--SELECT * FROM NUM_COUNT_MOST WHERE id16 = 44;
UPDATE a
SET a.QTY_STRING_MATCH = 1
FROM Brand_BVName_Result_AGAIN  AS a WITH(NOLOCK)
INNER JOIN NUM_COUNT_MOST AS b
ON a.ID16 = b.ID16 AND a.NUM = b.NUM
WHERE a.N = 1 AND b.COUNT_MAX_ORDER = 1;
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[写入品牌信息]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[首字匹配(不区分主子)]
UPDATE a
SET a.Brand_MAIN_MATCH_FIRST = c.N主品牌,--FIRST
    a.Brand_SUB_MATCH_FIRST = c.N子品牌--FIRST
FROM TASK_BRAND_MATCH AS a WITH(NOLOCK)/*目标表*/
INNER JOIN Brand_BVName_Result_AGAIN AS b WITH(NOLOCK)
ON a.ID16 = b.ID16
LEFT OUTER JOIN task_goods_Brand_BVName AS c WITH(NOLOCK)
ON b.NUM = c.NUM
WHERE b.FIRST_STRING_MATCH = 1;--FIRST
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[匹配字符最多]
UPDATE a
SET a.Brand_MAIN_MATCH_MOST = c.N主品牌,--MOST
    a.Brand_SUB_MATCH_MOST = c.N子品牌--MOST
FROM TASK_BRAND_MATCH               AS a WITH(NOLOCK)
INNER JOIN Brand_BVName_Result_AGAIN          AS b WITH(NOLOCK)
ON a.ID16 = b.ID16
LEFT OUTER JOIN task_goods_Brand_BVName AS c WITH(NOLOCK)
ON b.NUM = c.NUM
WHERE b.QTY_STRING_MATCH = 1;
--↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹↹[最终结果写入]
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[DECLARE]
DECLARE @ID99 INT;
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[SELECT]
--SELECT @ID99 = '9638';
--⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶⇶[循环集合]
IF OBJECT_ID('tempdb.dbo.#ID99', 'U') IS NOT NULL DROP TABLE #ID99;
SELECT *
INTO #ID99
FROM TASK_BRAND_MATCH WITH(NOLOCK)
WHERE N主品牌 IS NULL
AND   N子品牌 IS NULL;
--✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹✹[1]
WHILE EXISTS(SELECT TOP 1 * FROM #ID99 WITH(NOLOCK))
BEGIN
     /*单行处理锁定*/
     SELECT TOP 1 @ID99 = ID99 FROM #ID99 WITH(NOLOCK);
     /*邻近数据集合*/
     IF OBJECT_ID('tempdb.dbo.#UP_DOWN_SET', 'U') IS NOT NULL DROP TABLE #UP_DOWN_SET;
     WITH CTE_TARGET
     AS (SELECT *
         FROM TASK_BRAND_MATCH WITH(NOLOCK)
         WHERE ID99 = @ID99),
     CTE_UP
     AS (SELECT MAX(c.ID99) AS ID99_MAX
         FROM CTE_TARGET             AS b WITH(NOLOCK)
         INNER JOIN TASK_BRAND_MATCH AS c WITH(NOLOCK)
         ON b.ID99 > c.ID99
         WHERE c.N主品牌 IS NOT NULL),
     CTE_DOWN
     AS (SELECT MIN(e.ID99) AS ID99_MIN
         FROM CTE_TARGET             AS d WITH(NOLOCK)
         INNER JOIN TASK_BRAND_MATCH AS e WITH(NOLOCK)
         ON d.ID99 < e.ID99
         WHERE e.N主品牌 IS NOT NULL),
     CTE_SET
     AS (SELECT z.*
         FROM TASK_BRAND_MATCH AS z WITH(NOLOCK)
         INNER JOIN CTE_UP     AS y WITH(NOLOCK)
         ON z.ID99 = y.ID99_MAX
         UNION ALL
         SELECT v.*
         FROM TASK_BRAND_MATCH AS v WITH(NOLOCK)
         INNER JOIN CTE_DOWN   AS w WITH(NOLOCK)
         ON v.ID99 = w.ID99_MIN)
     SELECT *
     INTO #UP_DOWN_SET
     FROM CTE_SET WITH(NOLOCK);
     /*首字匹配*/
     UPDATE a
     SET a.N主品牌 = b.N主品牌,
         a.N子品牌 = b.N子品牌,
         a.N品牌厂商 = b.N品牌厂商,
         a.N品牌厂商简称 = b.N品牌厂商简称,
         a.BRAND_NULL = 1
     FROM TASK_BRAND_MATCH   AS a
     INNER JOIN #UP_DOWN_SET AS b
     ON  b.N主品牌 = a.Brand_MAIN_MATCH_FIRST--MAIN--FIRST
     AND b.N子品牌 = a.Brand_SUB_MATCH_FIRST--SUB--FIRST
     WHERE a.ID99 = @ID99;
     /*匹配字符最多*/
     UPDATE a
     SET a.N主品牌 = b.N主品牌,
         a.N子品牌 = b.N子品牌,
         a.N品牌厂商 = b.N品牌厂商,
         a.N品牌厂商简称 = b.N品牌厂商简称,
         a.BRAND_NULL = 1
     FROM TASK_BRAND_MATCH   AS a
     INNER JOIN #UP_DOWN_SET AS b
     ON  b.N主品牌 = a.Brand_MAIN_MATCH_MOST--MAIN--MOST
     AND b.N子品牌 = a.Brand_SUB_MATCH_MOST--SUB--MOST
     WHERE a.ID99 = @ID99;
     /*NEXT*/
     DELETE FROM #ID99 WHERE ID99 = @ID99;
END
```